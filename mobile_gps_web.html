<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile GPS Sender</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .gps-info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .auto-mode {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Mobile GPS Sender</h1>
            <p>Send live GPS data to Bus Tracking System</p>
        </div>

        <div id="status" class="status info">
            Ready to send GPS data
        </div>

        <div class="form-group">
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" value="http://127.0.0.1:8000" placeholder="http://127.0.0.1:8000">
        </div>

        <div class="form-group">
            <label for="busId">Bus ID:</label>
            <input type="text" id="busId" value="MOBILE-BUS-001" placeholder="MOBILE-BUS-001">
        </div>

        <div class="gps-info">
            <h3>üìç Current Location</h3>
            <p><strong>Latitude:</strong> <span id="currentLat">Not available</span></p>
            <p><strong>Longitude:</strong> <span id="currentLng">Not available</span></p>
            <p><strong>Accuracy:</strong> <span id="currentAccuracy">Not available</span></p>
            <p><strong>Last Updated:</strong> <span id="lastUpdated">Never</span></p>
        </div>

        <button onclick="getCurrentLocation()">üéØ Get Current Location</button>
        <button onclick="testConnection()">üîç Test Server Connection</button>
        <button onclick="sendCurrentLocation()" id="sendBtn" disabled>üì§ Send Current Location</button>

        <div class="auto-mode">
            <h3>üîÑ Auto Mode</h3>
            <div class="form-group">
                <label for="updateInterval">Update Interval (seconds):</label>
                <input type="number" id="updateInterval" value="5" min="1" max="60">
            </div>
            <button onclick="toggleAutoMode()" id="autoBtn">‚ñ∂Ô∏è Start Auto Mode</button>
        </div>

        <div class="form-group">
            <h3>üìù Manual Input</h3>
            <label for="manualLat">Latitude:</label>
            <input type="number" id="manualLat" step="any" placeholder="e.g., 28.6139">
            
            <label for="manualLng">Longitude:</label>
            <input type="number" id="manualLng" step="any" placeholder="e.g., 77.2090">
            
            <label for="manualSpeed">Speed (km/h):</label>
            <input type="number" id="manualSpeed" value="0" min="0" max="200">
            
            <label for="manualHeading">Heading (degrees):</label>
            <input type="number" id="manualHeading" value="0" min="0" max="360">
            
            <button onclick="sendManualLocation()">üì§ Send Manual Location</button>
        </div>
    </div>

    <script>
        let currentPosition = null;
        let autoModeInterval = null;
        let isAutoMode = false;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function getCurrentLocation() {
            updateStatus('Getting current location...', 'info');
            
            if (!navigator.geolocation) {
                updateStatus('Geolocation is not supported by this browser', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentPosition = position;
                    document.getElementById('currentLat').textContent = position.coords.latitude.toFixed(6);
                    document.getElementById('currentLng').textContent = position.coords.longitude.toFixed(6);
                    document.getElementById('currentAccuracy').textContent = position.coords.accuracy + ' meters';
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                    document.getElementById('sendBtn').disabled = false;
                    updateStatus('Location obtained successfully!', 'success');
                },
                (error) => {
                    updateStatus(`Error getting location: ${error.message}`, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        async function testConnection() {
            const serverUrl = document.getElementById('serverUrl').value;
            updateStatus('Testing server connection...', 'info');
            
            try {
                const response = await fetch(`${serverUrl}/api/get_locations/`);
                if (response.ok) {
                    updateStatus('Server connection successful!', 'success');
                } else {
                    updateStatus(`Server error: ${response.status}`, 'error');
                }
            } catch (error) {
                updateStatus(`Connection failed: ${error.message}`, 'error');
            }
        }

        async function sendGPSData(lat, lng, speed = 0, heading = 0) {
            const serverUrl = document.getElementById('serverUrl').value;
            const busId = document.getElementById('busId').value;
            
            // üöÄ Ensure consistent bus_id for mobile GPS mode
            const data = {
                bus_id: busId || 'MOBILE-BUS-001', // Fallback to default
                latitude: parseFloat(lat),
                longitude: parseFloat(lng),
                speed: parseFloat(speed),
                heading: parseFloat(heading)
            };
            
            console.log('üì§ Sending GPS data:', data); // Debug log

            try {
                const response = await fetch(`${serverUrl}/api/update_location/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    updateStatus(`GPS data sent successfully! (${lat.toFixed(6)}, ${lng.toFixed(6)})`, 'success');
                    return true;
                } else {
                    const error = await response.text();
                    updateStatus(`Failed to send GPS data: ${error}`, 'error');
                    return false;
                }
            } catch (error) {
                updateStatus(`Network error: ${error.message}`, 'error');
                return false;
            }
        }

        function sendCurrentLocation() {
            if (!currentPosition) {
                updateStatus('No current location available. Get location first.', 'error');
                return;
            }

            const speed = document.getElementById('manualSpeed').value || 0;
            const heading = document.getElementById('manualHeading').value || 0;
            
            sendGPSData(
                currentPosition.coords.latitude,
                currentPosition.coords.longitude,
                speed,
                heading
            );
        }

        function sendManualLocation() {
            const lat = document.getElementById('manualLat').value;
            const lng = document.getElementById('manualLng').value;
            const speed = document.getElementById('manualSpeed').value || 0;
            const heading = document.getElementById('manualHeading').value || 0;

            if (!lat || !lng) {
                updateStatus('Please enter both latitude and longitude', 'error');
                return;
            }

            sendGPSData(lat, lng, speed, heading);
        }

        function toggleAutoMode() {
            const autoBtn = document.getElementById('autoBtn');
            
            if (!isAutoMode) {
                // Start auto mode
                if (!currentPosition) {
                    updateStatus('Get current location first before starting auto mode', 'error');
                    return;
                }
                
                const interval = parseInt(document.getElementById('updateInterval').value) * 1000;
                const speed = document.getElementById('manualSpeed').value || 0;
                const heading = document.getElementById('manualHeading').value || 0;
                
                autoModeInterval = setInterval(() => {
                    getCurrentLocation(); // Update location
                    setTimeout(() => {
                        if (currentPosition) {
                            sendGPSData(
                                currentPosition.coords.latitude,
                                currentPosition.coords.longitude,
                                speed,
                                heading
                            );
                        }
                    }, 1000); // Wait 1 second for location update
                }, interval);
                
                isAutoMode = true;
                autoBtn.textContent = '‚èπÔ∏è Stop Auto Mode';
                autoBtn.style.backgroundColor = '#dc3545';
                updateStatus('Auto mode started', 'success');
                
            } else {
                // Stop auto mode
                if (autoModeInterval) {
                    clearInterval(autoModeInterval);
                    autoModeInterval = null;
                }
                
                isAutoMode = false;
                autoBtn.textContent = '‚ñ∂Ô∏è Start Auto Mode';
                autoBtn.style.backgroundColor = '#007bff';
                updateStatus('Auto mode stopped', 'info');
            }
        }

        // Initialize
        window.onload = function() {
            updateStatus('Ready to send GPS data', 'info');
        };
    </script>
</body>
</html>