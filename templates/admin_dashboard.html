{% extends "base.html" %}
{% block title %}Admin Panel ‚Äî Public Transport{% endblock %}
{% block head_extra %}
<style>
  body { background-color: #f5f5f5; }
  .header { background-color: #2c3e50; color: white; padding: 16px; display:flex; align-items:center; justify-content:space-between; }
  .layout { display:grid; grid-template-columns: 240px 1fr; gap: 16px; max-width: 1200px; margin: 0 auto; padding: 16px; }
  .sidebar { background:#ffffff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding:12px; position:sticky; top:10px; height: fit-content; }
  .sidebar h3 { margin:8px 0 12px 0; color:#2c3e50; }
  .sidebar .btn { display:block; width:100%; text-align:left; margin:6px 0; padding:10px 12px; background:#3498db; color:#fff; border:none; border-radius:6px; cursor:pointer; }
  .sidebar .btn.secondary { background:#27ae60; }
  .sidebar .btn.warn { background:#e67e22; }
  .sidebar .btn.purple { background:#8e44ad; }
  .panel { background: white; margin: 0 0 16px 0; padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .grid-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .stat { text-align:center; padding:16px; border-radius:8px; }
  .bus-item { display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:#ecf0f1; border-radius:5px; border-left:4px solid #3498db; }
  .bus-details h4 { margin:0 0 5px 0; }
  .bus-details p { margin:2px 0; font-size:14px; color:#666; }
  .status { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; }
  .status.active { background: #2ecc71; color: white; }
  .status.inactive { background: #e74c3c; color: white; }
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
  .modal-content { background-color: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 500px; max-width: 90%; }
  .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
  .close:hover { color: black; }
</style>
{% endblock %}
{% block content %}
  <div class="header">
    <h1>üõ†Ô∏è Public Transport ‚Äî Admin Dashboard</h1>
    <div class="nav-links">
      <a class="nav-link" href="/">Main</a>
      <a class="nav-link" href="/admin/">Django Admin</a>
    </div>
  </div>
  <div class="layout">
    <aside class="sidebar">
      <h3>Actions</h3>
      <button class="btn" onclick="loadStats()">Update Stats</button>
      <button class="btn" onclick="loadBuses()">Refresh Vehicles</button>
      <button class="btn" onclick="loadRoutes()">Refresh Routes</button>
      <button class="btn purple" onclick="openModal()">Add Route</button>
      <button class="btn secondary" onclick="document.getElementById('add-bus-form').scrollIntoView({behavior:'smooth'})">Add Vehicle</button>
      <button class="btn warn" onclick="clearOldLocations()">Clean Old Data</button>
      <button class="btn" onclick="exportData()">Export Data</button>
      <div style="margin-top:12px;">
        <input type="text" id="search-buses" placeholder="Search vehicles..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
        <button class="btn" style="margin-top:8px;" onclick="searchBuses()">Search</button>
      </div>
    </aside>
    <main>
      <div class="panel">
        <h3>Quick Stats</h3>
        <div class="grid-cards">
          <div class="stat" style="background:#e8f5e8;"><h2 id="total-buses" style="margin:0; color:#27ae60;">-</h2><p>Total Vehicles</p></div>
          <div class="stat" style="background:#e8f4fd;"><h2 id="active-buses" style="margin:0; color:#3498db;">-</h2><p>Active Vehicles</p></div>
          <div class="stat" style="background:#fff3cd;"><h2 id="total-routes" style="margin:0; color:#f39c12;">-</h2><p>Routes</p></div>
          <div class="stat" style="background:#fdeeee;"><h2 id="updates-1h" style="margin:0; color:#c0392b;">-</h2><p>Updates (1h)</p></div>
          <div class="stat" style="background:#eef9ff;"><h2 id="updates-24h" style="margin:0; color:#2980b9;">-</h2><p>Updates (24h)</p></div>
          <div class="stat" style="background:#eafaf1;"><h2 id="active-recent" style="margin:0; color:#27ae60;">-</h2><p>Active Recently (3m)</p></div>
        </div>
      </div>

      <div class="panel">
        <h3>Analytics</h3>
        <div style="display:grid; gap: 14px;">
          <div>
            <h4 style="margin:0 0 6px 0;">Route Breakdown</h4>
            <div id="route-breakdown" class="info-list"></div>
          </div>
          <div>
            <h4 style="margin:0 0 6px 0;">Recent Activity</h4>
            <div id="recent-activity" class="info-list"></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Add New Vehicle</h3>
        <form id="add-bus-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div class="form-group">
            <label for="bus-id">Vehicle ID</label>
            <input type="text" id="bus-id" name="bus_id" required placeholder="e.g., VEH-003">
          </div>
          <div class="form-group">
            <label for="bus-number">Vehicle Number</label>
            <input type="text" id="bus-number" name="bus_number" required placeholder="e.g., DL-123">
          </div>
          <div class="form-group">
            <label for="vehicle-type">Type</label>
            <select id="vehicle-type" name="vehicle_type">
              <option value="bus">Bus</option>
              <option value="metro">Metro</option>
              <option value="tram">Tram</option>
              <option value="train">Train</option>
              <option value="ferry">Ferry</option>
            </select>
          </div>
          <div class="form-group">
            <label for="route-select">Route</label>
            <select id="route-select" name="route_id" required>
              <option value="">Loading routes...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="driver-name">Driver Name</label>
            <input type="text" id="driver-name" name="driver_name" placeholder="Optional">
          </div>
          <div class="form-group">
            <label for="capacity">Capacity</label>
            <input type="number" id="capacity" name="capacity" value="50" min="1">
          </div>
          <div class="form-group" style="display: flex; align-items: end;">
            <button type="submit">Add Vehicle</button>
          </div>
        </form>
      </div>

      <div class="panel">
        <h3>Vehicle Management</h3>
        <div id="buses-list">
          <div style="text-align: center; padding: 20px; color: #666;">Loading vehicles...</div>
        </div>
      </div>
    </main>
  </div>

  <div id="route-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Add New Route</h3>
      <form id="add-route-form">
        <div class="form-group">
          <label for="route-id">Route ID</label>
          <input type="text" id="route-id" name="route_id" required placeholder="e.g., ROUTE-001">
        </div>
        <div class="form-group">
          <label for="route-name">Route Name</label>
          <input type="text" id="route-name" name="name" required placeholder="e.g., Central Line">
        </div>
        <div class="form-group">
          <label for="start-location">Start Location</label>
          <input type="text" id="start-location" name="start_location" required>
        </div>
        <div class="form-group">
          <label for="end-location">End Location</label>
          <input type="text" id="end-location" name="end_location" required>
        </div>
        <div class="form-group">
          <label for="route-description">Description</label>
          <input type="text" id="route-description" name="description" placeholder="Optional">
        </div>
        <button type="submit">Add Route</button>
      </form>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>
  let buses = [];
  let routes = [];

  async function fetchJSON(url, options = {}) { const res = await fetch(url, options); return res.json(); }
  function showNotification(message) { alert(message); }

  window.onload = function() {
    loadStats();
    loadBuses();
    loadRoutes();
    document.getElementById('add-bus-form').addEventListener('submit', addBus);
    document.getElementById('add-route-form').addEventListener('submit', addRoute);
  };

  async function loadStats() {
    try {
      const [busesData, routesData, analyticsData] = await Promise.all([
        fetchJSON('/api/admin/list_buses/'),
        fetchJSON('/api/routes/'),
        fetchJSON('/api/admin/analytics/')
      ]);
      if (busesData.status === 'success') {
        const total = busesData.buses.length;
        const active = busesData.buses.filter(b => b.is_active).length;
        document.getElementById('total-buses').textContent = total;
        document.getElementById('active-buses').textContent = active;
      }
      if (routesData.status === 'success') {
        document.getElementById('total-routes').textContent = routesData.routes.length;
      }
      if (analyticsData.status === 'success') {
        const s = analyticsData.summary;
        document.getElementById('updates-1h').textContent = s.updates_last_hour;
        document.getElementById('updates-24h').textContent = s.updates_last_24h;
        document.getElementById('active-recent').textContent = s.active_recent;
        renderRouteBreakdown(analyticsData.routes);
        renderRecentActivity(analyticsData.recent_activity);
      }
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }

  function renderRouteBreakdown(items){ const el = document.getElementById('route-breakdown'); if(!items || items.length===0){ el.innerHTML = '<div style="color:#666">No route data</div>'; return; } el.innerHTML = items.map(r=>`<div class=\"bus-item\"><div class=\"bus-details\"><h4>${r.name} (${r.route_id})</h4><p><strong>Vehicles:</strong> ${r.buses}</p></div><div><div class=\"status ${r.active_recent>0?'active':'inactive'}\">${r.active_recent} active</div></div></div>`).join(''); }
  function renderRecentActivity(items){ const el = document.getElementById('recent-activity'); if(!items || items.length===0){ el.innerHTML = '<div style="color:#666">No recent activity</div>'; return; } el.innerHTML = items.map(a=>`<div class=\"bus-item\"><div class=\"bus-details\"><h4>${a.bus_number} (${a.bus_id})</h4><p><strong>Route:</strong> ${a.route_id||'N/A'} | <strong>Coords:</strong> ${a.latitude.toFixed(4)}, ${a.longitude.toFixed(4)}</p></div><div><div class=\"status active\">${new Date(a.last_updated).toLocaleTimeString()}</div></div></div>`).join(''); }

  async function loadBuses() {
    try {
      const data = await fetchJSON('/api/admin/list_buses/');
      if (data.status === 'success') { buses = data.buses; displayBuses(buses); }
    } catch (error) {
      console.error('Error loading vehicles:', error);
      document.getElementById('buses-list').innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading vehicles</div>';
    }
  }

  async function loadRoutes() {
    try { const data = await fetchJSON('/api/admin/list_routes/'); if (data.status === 'success') { routes = data.routes; updateRouteSelect(); } } catch (error) { console.error('Error loading routes:', error); }
  }

  function updateRouteSelect(){ const select = document.getElementById('route-select'); select.innerHTML = '<option value="">Select a route</option>'; routes.forEach(route => { const option = document.createElement('option'); option.value = route.route_id; option.textContent = `${route.route_id} - ${route.name}`; select.appendChild(option); }); }

  function displayBuses(list){ const container = document.getElementById('buses-list'); if (list.length === 0) { container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No vehicles found</div>'; return; } const html = list.map(bus => `<div class=\"bus-item\"><div class=\"bus-details\"><h4>${bus.bus_number} (${bus.bus_id})</h4><p><strong>Type:</strong> ${bus.vehicle_type}</p><p><strong>Route:</strong> ${bus.route_name || 'N/A'}</p><p><strong>Driver:</strong> ${bus.driver_name || 'N/A'}</p><p><strong>Capacity:</strong> ${bus.capacity} passengers</p>${bus.current_location ? `<p><strong>Location:</strong> ${bus.current_location.latitude.toFixed(4)}, ${bus.current_location.longitude.toFixed(4)}</p><p><strong>Last Update:</strong> ${new Date(bus.current_location.last_updated).toLocaleString()}</p>` : '<p><strong>Location:</strong> No recent data</p>'}</div><div><div class=\"status ${bus.is_active ? 'active' : 'inactive'}\">${bus.is_active ? 'ACTIVE' : 'INACTIVE'}</div><button onclick=\"toggleBusStatus('${bus.bus_id}', ${bus.is_active})\" style=\"margin-top: 10px; font-size: 12px; padding: 5px 10px;\">${bus.is_active ? 'Deactivate' : 'Activate'}</button></div></div>`).join(''); container.innerHTML = html; }

  async function addBus(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const payload = { bus_id: formData.get('bus_id'), bus_number: formData.get('bus_number'), route_id: formData.get('route_id'), driver_name: formData.get('driver_name'), capacity: parseInt(formData.get('capacity')), vehicle_type: formData.get('vehicle_type') };
    try { const result = await fetchJSON('/api/admin/add_bus/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (result.status === 'success') { showNotification('Vehicle added successfully!'); event.target.reset(); loadBuses(); loadStats(); } else { showNotification(result.error || 'Failed to add vehicle'); } } catch (error) { console.error('Error adding vehicle:', error); showNotification('Network error while adding vehicle'); }
  }

  async function searchBuses(){ const query = document.getElementById('search-buses').value.trim(); if (!query) { displayBuses(buses); return; } try { const data = await fetchJSON(`/api/search_buses/?q=${encodeURIComponent(query)}`); if (data.status === 'success') { displayBuses(data.buses.map(b => ({ ...b, id: b.bus_id, is_active: true }))); } } catch (error) { console.error('Error searching vehicles:', error); } }

  async function toggleBusStatus(busId, currentStatus){ try { const res = await fetchJSON('/api/admin/toggle_bus_status/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bus_id: busId, is_active: !currentStatus }) }); if (res.status==='success'){ showNotification('Status updated'); loadBuses(); loadStats(); } else { showNotification(res.error || 'Failed to toggle'); } } catch(e){ console.error(e); showNotification('Network error'); } }

  function openModal(){ document.getElementById('route-modal').style.display = 'block'; }
  function closeModal(){ document.getElementById('route-modal').style.display = 'none'; }

  async function addRoute(event){ event.preventDefault(); const fd = new FormData(event.target); const payload = { route_id: fd.get('route_id'), name: fd.get('name'), start_location: fd.get('start_location'), end_location: fd.get('end_location'), description: fd.get('description') }; try{ const res = await fetchJSON('/api/admin/add_route/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); if(res.status==='success'){ showNotification('Route added'); closeModal(); loadRoutes(); } else { showNotification(res.error || 'Failed to add route'); } }catch(e){ console.error(e); showNotification('Network error'); }
  }

  async function clearOldLocations(){ if (!confirm('This will remove location data older than 7 days. Continue?')) return; try{ const res = await fetchJSON('/api/admin/clean_old_locations/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ days: 7 }) }); if(res.status==='success'){ showNotification(`Deleted ${res.deleted} old location records`); loadStats(); } else { showNotification(res.error || 'Failed to clean'); } }catch(e){ console.error(e); showNotification('Network error'); }
  }

  function exportData(){ if (buses.length === 0) { showNotification('No data to export'); return; } const csv = [ ['Vehicle ID', 'Vehicle Number', 'Type', 'Route', 'Driver', 'Capacity', 'Status', 'Last Latitude', 'Last Longitude', 'Last Update'].join(','), ...buses.map(bus => [ bus.bus_id, bus.bus_number, bus.vehicle_type, bus.route_name || '', bus.driver_name || '', bus.capacity, bus.is_active ? 'Active' : 'Inactive', bus.current_location ? bus.current_location.latitude : '', bus.current_location ? bus.current_location.longitude : '', bus.current_location ? bus.current_location.last_updated : '' ].join(',')) ].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `vehicles_${new Date().toISOString().split('T')[0]}.csv`; a.click(); window.URL.revokeObjectURL(url); }
</script>
{% endblock %}

