{% extends "base.html" %}
{% block title %}User Dashboard ‚Äî Real-Time Public Transport Tracking{% endblock %}
{% block head_extra %}
<style>
  /* Match admin theme */
  .user-shell { display:grid; grid-template-columns: 240px 420px 1fr; gap: 16px; max-width: 1400px; margin: 0 auto; padding: 16px; }
  .sidebar { background: linear-gradient(180deg, var(--panel) 0%, rgba(0,0,0,0.2) 100%); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:12px; height: calc(100vh - 90px); position: sticky; top: 72px; overflow:auto; }
  .sb-brand { display:flex; align-items:center; gap:8px; font-weight:700; margin-bottom:10px; }
  .sb-brand .dot { width:9px; height:9px; border-radius:50%; background: var(--accent); }
  .sb-nav { display:flex; flex-direction:column; gap:6px; }
  .sb-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid transparent; cursor:pointer; color:var(--text); }
  .sb-item:hover { background: rgba(124,58,237,0.08); border-color: var(--border); }
  .sb-item.active { background: rgba(124,58,237,0.16); border-color: rgba(124,58,237,0.35); }

  .list-panel, .map-panel { background: var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); }
  .list-panel { padding: 12px; display:flex; flex-direction:column; }
  .lp-head { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; }
  .lp-title { font-weight:700; }
  .chip-row { display:flex; gap:6px; flex-wrap:wrap; }
  .chip { font-size:12px; padding:6px 10px; border-radius:999px; background: var(--card); border:1px solid var(--border); color: var(--text); cursor:pointer; }
  .chip.on { background: rgba(124,58,237,0.16); border-color: rgba(124,58,237,0.35); }

  .search { display:flex; gap:8px; align-items:center; background: var(--card); border:1px solid var(--border); padding: 8px 10px; border-radius: 10px; }
  .search input, .search select { background: transparent; border: none; outline: none; color: var(--text); }
  .btn { background: linear-gradient(135deg, var(--accent), #4f46e5); border:none; color:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; }
  .btn.secondary { background: linear-gradient(135deg, var(--accent-2), #16a34a); }
  .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

  .info-list { display:flex; flex-direction:column; gap:8px; padding:8px; overflow:auto; }
  .item { display:flex; align-items:center; justify-content:space-between; gap:8px; background: var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; }
  .item .muted { color: var(--muted); font-size:12px; }
  .status { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
  .status.ok { background: rgba(34,197,94,0.18); color:#22c55e; border:1px solid rgba(34,197,94,0.35); }
  .status.warn { background: rgba(245,158,11,0.18); color:#f59e0b; border:1px solid rgba(245,158,11,0.35); }
  .status.off { background: rgba(239,68,68,0.18); color:#ef4444; border:1px solid rgba(239,68,68,0.35); }

  .map-panel { position:relative; overflow:hidden; }
  #map { height: calc(100vh - 90px); width: 100%; border-radius:16px; }
  #mapCanvas { display:block; width:100%; height:100%; }
  .map-overlay { position:absolute; top:12px; left: 50%; transform: translateX(-50%); background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px; box-shadow: var(--shadow); min-width: 280px; }

  @media (max-width: 1200px){ .user-shell { grid-template-columns: 220px 1fr; } .map-panel { grid-column: span 2; } #map { height: 480px; } }
  @media (max-width: 760px){ .user-shell { grid-template-columns: 1fr; } .map-panel { grid-column: span 1; } #map { height: 420px; } .sidebar { height:auto; position:static; } }
</style>
{% endblock %}
{% block content %}
<div class="user-shell">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sb-brand"><span class="dot"></span><span>Public</span></div>
    <div class="sb-nav">
      <div id="nav-vehicles" class="sb-item active">üöç Vehicles</div>
      <div id="nav-delays" class="sb-item">‚è± Delay reports</div>
      <div id="nav-track" class="sb-item">üìç Track vehicle</div>
      <div id="nav-help" class="sb-item">‚ùì Help</div>
    </div>
  </aside>

  <!-- List panel -->
  <section class="list-panel">
    <div class="lp-head">
      <div class="lp-title" id="lp-title">Vehicles</div>
      <div class="search"><input id="search-query" placeholder="Search vehicles, routes, IDs" /><button id="btn-search" class="btn">Search</button></div>
    </div>
    <div class="lp-head" style="margin-top: -6px;">
      <div class="chip-row" id="chip-row">
        <span id="chip-all" class="chip on">All</span>
        <span id="chip-active" class="chip">In-transit</span>
        <span id="chip-off" class="chip">Offline</span>
      </div>
      <div class="search" id="route-tools">
        <label style="color:var(--muted); font-size:12px;">Route&nbsp;</label>
        <select id="route-filter"><option value="">All</option></select>
        <button id="btn-apply-route" class="btn secondary">Apply</button>
      </div>
    </div>

    <!-- Vehicles Section -->
    <div id="section-vehicles">
      <div style="display:flex; gap:8px; padding: 0 8px;">
        <button id="btn-refresh" class="btn" style="flex:1;">Refresh</button>
        <button id="btn-my-location" class="btn secondary" style="flex:1;">My Location</button>
        <div class="search" style="flex:1; justify-content:space-between;">
          <label style="color:var(--muted); font-size:12px;">Radius&nbsp;(km)</label>
          <input id="radius-km" type="number" min="1" max="50" value="5" style="width:80px;" />
          <button id="btn-nearest" class="btn" style="margin-left:auto;">Find</button>
        </div>
      </div>
      <div id="nearest-results" style="padding: 8px 8px 0 8px;"></div>
      <div class="info-list" id="bus-list" style="min-height:280px;"><div class="item"><div><strong>Loading‚Ä¶</strong><div class="muted">Fetching live vehicles</div></div></div></div>
    </div>

    <!-- Delay Reports Section -->
    <div id="section-delays" style="display:none; padding: 8px;">
      <div style="display:flex; align-items:center; justify-content:space-between; padding: 0 0 6px 0;">
        <div style="font-weight:700;">Delay Report</div>
        <button id="btn-delay" class="btn warning">Check Delay</button>
      </div>
      <div id="delay-results" class="info-list"><div class="muted">Click "Check Delay" to analyze last updates.</div></div>
    </div>

    <!-- Track Vehicle Section -->
    <div id="section-track" style="display:none; padding: 8px;">
      <div class="search" style="margin-bottom:8px; width:100%;">
        <input id="track-id" placeholder="Enter vehicle ID (e.g., BUS-001)" style="flex:1;" />
        <button id="btn-track" class="btn">Track</button>
      </div>
      <div id="track-result" class="info-list"><div class="muted">Search a vehicle to see its latest location and center the map.</div></div>
    </div>
  </section>

  <!-- Map panel -->
  <section class="map-panel">
    <div class="map-overlay">
      <div style="font-weight:700;">Map</div>
      <div style="color:var(--muted); font-size:12px;">Satellite and layers are auto-managed</div>
    </div>
    <div id="map"></div>
  </section>
</div>
{% endblock %}
{% block scripts %}
<script>
  // Filter chips
  function setChip(on){ ['chip-all','chip-active','chip-off'].forEach(id=>document.getElementById(id).classList.remove('on')); document.getElementById(on).classList.add('on'); }

  // Existing logic preserved below
  let map; let markers = {}; let infoWindows = {}; let routes = []; let initialized = false;
  let userMarker = null; let userCanvasPos = null; let lastUserPos = null;

  function initMap() {
    if (initialized) return; initialized = true;
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 11,
      center: { lat: 28.6139, lng: 77.2090 },
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
    });
    fetchBusLocations();
    setInterval(fetchBusLocations, 5000);
  }

  async function fetchJSON(url, options={}){ const res = await fetch(url, options); if(!res.ok) throw new Error(res.status+" "+res.statusText); return res.json(); }

  function fetchBusLocations(){
    fetchJSON('/api/get_locations/').then(data=>{
      if(data.status==='success'){ updateMap(data.locations); updateBusList(data.locations); }
      else { updateBusList([]); }
    }).catch(()=>updateBusList([]));
  }

  async function loadRoutes(){
    try{ const data = await fetchJSON('/api/routes/'); if(data.status==='success'){ routes=data.routes||[]; const sel=document.getElementById('route-filter'); sel.innerHTML='<option value="">All routes</option>' + routes.map(r=>`<option value="${r.route_id}">${r.route_id} - ${r.name}</option>`).join(''); } }
    catch(e){ console.error('routes',e); }
  }

  async function reverseGeocode(lat, lng){
    try { if (typeof google !== 'undefined' && google.maps && google.maps.Geocoder) { const geocoder = new google.maps.Geocoder(); return await new Promise((resolve) => { geocoder.geocode({ location: { lat, lng } }, (results, status) => { if (status === 'OK' && results && results[0]) resolve(results[0].formatted_address); else resolve(`${lat.toFixed(4)}, ${lng.toFixed(4)}`); }); }); } }
    catch (_) {}
    try { const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`; const res = await fetch(url, { headers: { 'Accept': 'application/json' } }); const data = await res.json(); return data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`; } catch(_) { return `${lat.toFixed(4)}, ${lng.toFixed(4)}`; }
  }

  function setUserMarker(lat, lng, label){
    lastUserPos = { lat, lng };
    if (typeof google !== 'undefined' && map) {
      if (!userMarker) {
        userMarker = new google.maps.Marker({ position: {lat, lng}, map, title: 'You are here', icon: { url:'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"36\" height=\"36\" viewBox=\"0 0 36 36\"><circle cx=\"18\" cy=\"18\" r=\"14\" fill=\"#22c55e\" stroke=\"#145a32\" stroke-width=\"2\"/><text x=\"18\" y=\"22\" text-anchor=\"middle\" fill=\"white\" font-family=\"Arial\" font-size=\"12\" font-weight=\"bold\">‚óé</text></svg>`), scaledSize: new google.maps.Size(36,36), anchor: new google.maps.Point(18,18) } });
      } else { userMarker.setPosition({lat, lng}); }
      map.setCenter({lat, lng});
    } else if (ctx) {
      userCanvasPos = {lat, lng}; updateSimpleMap([]);
    }
    const nearDiv = document.getElementById('nearest-results');
    if (label) nearDiv.innerHTML = `<div class='item'><div><strong>My Location</strong><br><span class='muted'>${label}</span></div><div><span class='status ok'>SET</span></div></div>`;
  }

  async function useMyLocation(){ if(!navigator.geolocation){ alert('Geolocation not supported'); return; } navigator.geolocation.getCurrentPosition(async (pos)=>{ const { latitude, longitude, accuracy } = pos.coords; try { await fetchJSON('/api/update_user_location/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ latitude, longitude, accuracy })}); const label = await reverseGeocode(latitude, longitude); setUserMarker(latitude, longitude, label); } catch(e){ console.error(e); } }, (err)=>alert('Failed: '+err.message)); }

  async function findNearest(){ const radius = parseFloat(document.getElementById('radius-km').value||'5'); let lat, lng; if (lastUserPos) { lat = lastUserPos.lat; lng = lastUserPos.lng; } else { const pos = await new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r(p), ()=>r(null))); lat = pos?pos.coords.latitude:28.6139; lng = pos?pos.coords.longitude:77.2090; } try{ const data = await fetchJSON(`/api/find_nearest_buses/?lat=${lat}&lng=${lng}&radius=${radius}`); if(data.status==='success'){ const mapped = (data.nearest_buses||[]).map(b=>({ bus_id:b.bus_id, bus_number:b.bus_number, route_name:b.route_name, route_id:b.route_id, latitude:b.latitude, longitude:b.longitude, last_updated:b.last_updated||new Date().toISOString() })); const html = mapped.map(b=>`<div class='item'><div><strong>${b.bus_number} (${b.bus_id})</strong><br><span class='muted'>Route: ${b.route_name||'N/A'}</span></div><div><span class='status ok'>${(data.search_radius_km||radius)} km</span></div></div>`).join(''); document.getElementById('nearest-results').innerHTML = html || '<div class=\"muted\">No vehicles nearby</div>'; updateMap(mapped); } }catch(e){ console.error(e); }
  }

  function toMapModels(arr){ return (arr||[]).map(b=>({ bus_id:b.bus_id, bus_number:b.bus_number, route_name:b.route_name, route_id:b.route_id, latitude:(b.current_location && b.current_location.latitude)||b.latitude||28.6139, longitude:(b.current_location && b.current_location.longitude)||b.longitude||77.2090, last_updated:(b.current_location && b.current_location.last_updated)||b.last_updated||new Date().toISOString() })); }

  async function searchBuses(){ const q = encodeURIComponent(document.getElementById('search-query').value.trim()); const data = await fetchJSON(`/api/search_buses/?q=${q}`); if(data.status==='success'){ const models = toMapModels(data.buses); updateBusList(models); updateMap(models); }
    setChip('chip-all'); }

  async function applyRouteFilter(){ const route = document.getElementById('route-filter').value; if(!route){ fetchBusLocations(); setChip('chip-all'); return; } const data = await fetchJSON(`/api/search_buses/?route=${encodeURIComponent(route)}`); if(data.status==='success'){ const models = toMapModels(data.buses); updateBusList(models); updateMap(models); setChip('chip-all'); } }

  async function checkDelays(){ try{ const data = await fetchJSON('/api/get_locations/'); if(data.status!=='success'){ return; } const now = new Date(); const items = (data.locations||[]).map(loc=>{ const last = new Date(loc.last_updated); const diff = (now - last)/1000; let status='ok', label='ON TIME'; if(diff>180) { status='off'; label='OFFLINE'; } else if(diff>120) { status='warn'; label='DELAYED'; } return { ...loc, status, label, agoSec: Math.round(diff) }; }).filter(x=>x.status!=='ok'); const html = items.length? items.map(x=>`<div class='item'><div><strong>${x.bus_number} (${x.bus_id})</strong><br><span class='muted'>Last: ${new Date(x.last_updated).toLocaleTimeString()}</span></div><div><span class='status ${x.status}'>${x.label}</span></div></div>`).join('') : '<div class="muted">No delayed vehicles detected (last 2 minutes)</div>'; document.getElementById('delay-results').innerHTML = html; setChip('chip-off'); }catch(e){ console.error(e); }
  }

  function updateMap(locations){ if(typeof google!=='undefined' && map){ updateGoogleMap(locations); } else if(ctx){ updateSimpleMap(locations); } }

  function formatAgo(iso){ try{ const d=new Date(iso); const s=Math.max(0, Math.floor((Date.now()-d.getTime())/1000)); if(s<60) return s+"s ago"; const m=Math.floor(s/60); if(m<60) return m+"m ago"; const h=Math.floor(m/60); return h+"h ago"; }catch(_){ return ''; } }

  function updateBusList(list){ const el = document.getElementById('bus-list'); const items = (list||[]); if(items.length===0){ el.innerHTML = '<div class="muted">No live vehicles</div>'; return; } el.innerHTML = items.map(b=>{ const lat = (b.current_location?b.current_location.latitude:b.latitude)||0; const lng = (b.current_location?b.current_location.longitude:b.longitude)||0; const last = (b.current_location?b.current_location.last_updated:b.last_updated)||''; const route = b.route_name||b.route_id||'N/A'; const title = `${b.bus_number||b.bus_id} (${b.bus_id})`; return `<div class='item'><div><strong>${title}</strong><br><span class='muted'>Route: ${route} ‚Ä¢ ${lat.toFixed?lat.toFixed(4):lat}, ${lng.toFixed?lng.toFixed(4):lng}</span></div><div><button class='btn secondary' onclick='focusBus(${lat}, ${lng})'>Focus</button><div class='muted' style='text-align:right'>${formatAgo(last)}</div></div></div>`; }).join(''); }

  function focusBus(lat, lng){ if(typeof google!=='undefined' && map){ map.setCenter({lat, lng}); map.setZoom(14); } else { userCanvasPos = {lat, lng}; updateSimpleMap([]); } }

  function updateGoogleMap(loc){ const activeIds = loc.map(l=>l.bus_id); Object.keys(markers).forEach(id=>{ if(!activeIds.includes(id)){ markers[id].setMap(null); if(infoWindows[id]) infoWindows[id].close(); delete markers[id]; delete infoWindows[id]; }}); loc.forEach(l=>{ const position = { lat:l.latitude, lng:l.longitude }; if(markers[l.bus_id]){ markers[l.bus_id].setPosition(position); } else { markers[l.bus_id] = new google.maps.Marker({ position, map, title:l.bus_id, icon: { url: 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"30\" height=\"30\" viewBox=\"0 0 30 30\"><circle cx=\"15\" cy=\"15\" r=\"12\" fill=\"${'#38bdf8'}\" stroke=\"${'#1e293b'}\" stroke-width=\"2\"/><text x=\"15\" y=\"19\" text-anchor=\"middle\" fill=\"white\" font-family=\"Arial\" font-size=\"10\" font-weight=\"bold\">üöç</text></svg>`), scaledSize:new google.maps.Size(30,30), anchor:new google.maps.Point(15,15) } }); } const iw = `<div style='padding:10px;'><h4 style='margin:0 0 8px 0;color:#0b1020'>${l.bus_id}</h4><div class='muted'>${l.latitude.toFixed(4)}, ${l.longitude.toFixed(4)}</div><div class='muted'>${new Date(l.last_updated).toLocaleTimeString()}</div></div>`; if(infoWindows[l.bus_id]) infoWindows[l.bus_id].setContent(iw); else { infoWindows[l.bus_id] = new google.maps.InfoWindow({ content: iw }); markers[l.bus_id].addListener('click', ()=>{ Object.values(infoWindows).forEach(x=>x.close()); infoWindows[l.bus_id].open(map, markers[l.bus_id]); }); } }); if (userMarker) { userMarker.setMap(map); } }

  // Simple canvas map fallback
  let simpleMap, ctx; const mapBounds={ minLat:28.5, maxLat:28.7, minLng:77.15, maxLng:77.4 };
  function initSimpleMap(){ if (initialized) return; initialized = true; simpleMap = document.getElementById('map'); simpleMap.innerHTML = '<canvas id="mapCanvas"></canvas>'; const canvas = document.getElementById('mapCanvas'); const r = simpleMap.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; canvas.style.width=r.width+'px'; canvas.style.height=r.height+'px'; ctx = canvas.getContext('2d'); drawMapBackground(); fetchBusLocations(); setInterval(fetchBusLocations, 5000); }
  function drawMapBackground(){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); ctx.fillStyle='#0b1020'; ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height); ctx.strokeStyle='#20293a'; for(let i=0;i<=10;i++){ const x=(ctx.canvas.width/10)*i; const y=(ctx.canvas.height/10)*i; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ctx.canvas.height); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(ctx.canvas.width,y); ctx.stroke(); } ctx.fillStyle='#9aa4b2'; ctx.font='bold 16px Arial'; ctx.textAlign='center'; ctx.fillText('Public Transport Map', ctx.canvas.width/2, 28); }
  function latLngToPixel(lat,lng){ const x=((lng-mapBounds.minLng)/(mapBounds.maxLng-mapBounds.minLng))*ctx.canvas.width; const y=((mapBounds.maxLat-lat)/(mapBounds.maxLat-mapBounds.minLat))*ctx.canvas.height; return {x,y}; }
  function drawBusMarker(l,c='#38bdf8'){ const p=latLngToPixel(l.latitude,l.longitude); ctx.beginPath(); ctx.arc(p.x,p.y,15,0,Math.PI*2); ctx.fillStyle=c; ctx.fill(); ctx.strokeStyle='#1e293b'; ctx.lineWidth=2; ctx.stroke(); ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.textAlign='center'; ctx.fillText('üöç',p.x,p.y+4); ctx.fillStyle='#e5e7eb'; ctx.font='bold 11px Arial'; ctx.fillText(l.bus_number||l.bus_id,p.x,p.y-28); ctx.font='9px Arial'; ctx.fillStyle='#9aa4b2'; ctx.fillText(`(${l.route_name||l.route_id||'Unknown'})`,p.x,p.y-16); }
  function updateSimpleMap(loc){ drawMapBackground(); loc.forEach((l,i)=>{ const colors=['#38bdf8','#ef4444','#22c55e','#f59e0b','#a78bfa']; drawBusMarker(l,colors[i%colors.length]); }); if (userCanvasPos){ const p = latLngToPixel(userCanvasPos.lat, userCanvasPos.lng); ctx.beginPath(); ctx.arc(p.x,p.y,12,0,Math.PI*2); ctx.fillStyle='#22c55e'; ctx.fill(); ctx.strokeStyle='#14532d'; ctx.lineWidth=2; ctx.stroke(); ctx.fillStyle='#fff'; ctx.font='bold 11px Arial'; ctx.textAlign='center'; ctx.fillText('‚óé', p.x, p.y+4); } }

  // Hook controls & initialize
  window.onload = function(){
    // Vehicles section events
    const byId = (id)=>document.getElementById(id);
    byId('btn-refresh').onclick = fetchBusLocations;
    byId('btn-my-location').onclick = useMyLocation;
    byId('btn-nearest').onclick = findNearest;
    byId('btn-search').onclick = searchBuses;
    byId('search-query').addEventListener('keydown', function(e){ if(e.key==='Enter'){ searchBuses(); }});
    byId('btn-apply-route').onclick = applyRouteFilter;

    // Delay section
    byId('btn-delay').onclick = checkDelays;

    // Track section
    byId('btn-track').onclick = async()=>{
      const id = (byId('track-id').value||'').trim();
      const box = byId('track-result');
      if(!id){ box.innerHTML = '<div class="muted">Enter a vehicle ID</div>'; return; }
      try{
        const data = await fetchJSON(`/api/search_buses/?q=${encodeURIComponent(id)}`);
        if(data.status==='success' && data.buses.length){
          const b = data.buses[0];
          const m = { latitude: b.current_location?.latitude, longitude: b.current_location?.longitude };
          if (m.latitude && m.longitude) focusBus(m.latitude, m.longitude);
          box.innerHTML = `<div class='item'><div><strong>${b.bus_number} (${b.bus_id})</strong><br><span class='muted'>Route: ${b.route_name||'N/A'}</span></div><div><span class='status ok'>FOUND</span></div></div>`;
        } else { box.innerHTML = '<div class="muted">No vehicle found</div>'; }
      }catch(e){ box.innerHTML = '<div class="muted">Search error</div>'; }
    };

    // Sidebar navigation switches panel content
    const showSection = (name)=>{
      const map = { vehicles:'section-vehicles', delays:'section-delays', track:'section-track' };
      Object.values(map).forEach(id=>{ const el=byId(id); if(el) el.style.display='none'; });
      byId(map[name]).style.display = 'block';
      byId('lp-title').textContent = name==='vehicles' ? 'Vehicles' : name==='delays' ? 'Delay Reports' : 'Track Vehicle';
      byId('chip-row').style.display = name==='vehicles' ? 'flex' : 'none';
      byId('route-tools').style.display = name==='vehicles' ? 'flex' : 'none';
    };
    byId('nav-vehicles').onclick = ()=>{ document.querySelectorAll('.sb-item').forEach(n=>n.classList.remove('active')); byId('nav-vehicles').classList.add('active'); showSection('vehicles'); };
    byId('nav-delays').onclick = ()=>{ document.querySelectorAll('.sb-item').forEach(n=>n.classList.remove('active')); byId('nav-delays').classList.add('active'); showSection('delays'); };
    byId('nav-track').onclick = ()=>{ document.querySelectorAll('.sb-item').forEach(n=>n.classList.remove('active')); byId('nav-track').classList.add('active'); showSection('track'); };
    byId('nav-help').onclick = ()=> alert('Use the sidebar to switch between sections.');

    // chip handlers (client-side visual filter only)
    byId('chip-all').onclick = ()=>{ setChip('chip-all'); fetchBusLocations(); };
    byId('chip-active').onclick = ()=>{ setChip('chip-active'); fetchJSON('/api/get_locations/').then(d=>{ const all=d.status==='success'?d.locations:[]; const now=Date.now(); const act=all.filter(x=> (now - new Date(x.last_updated).getTime())/1000 <= 120); updateBusList(act); updateMap(act); }); };
    byId('chip-off').onclick = ()=>{ setChip('chip-off'); fetchJSON('/api/get_locations/').then(d=>{ const all=d.status==='success'?d.locations:[]; const now=Date.now(); const off=all.filter(x=> (now - new Date(x.last_updated).getTime())/1000 > 180); updateBusList(off); updateMap(off); }); };

    loadRoutes();
    if (typeof google === 'undefined') initSimpleMap(); else initMap();
  };
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnOhQzKOIz6i3t_a0oK6K2d7bQ7BG2SFU&callback=initMap"></script>
{% endblock %}

