{% extends "base.html" %}
{% load static %}
{% block title %}Transport Tracking Dashboard{% endblock %}
{% block head_extra %}
<style>
  /* Modern Theme Variables */
  :root {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --surface: #ffffff;
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --accent-primary: #3b82f6;
    --accent-secondary: #10b981;
    --accent-warning: #f59e0b;
    --accent-danger: #ef4444;
    --border: #e2e8f0;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
    --radius: 12px;
    --radius-lg: 16px;
  }

  [data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --surface: #1e293b;
    --text-primary: #f8fafc;
    --text-secondary: #cbd5e1;
    --text-muted: #64748b;
    --border: #334155;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-x: hidden;
  }

  /* Navigation - Uses theme variables */
  .navbar {
    background: var(--surface);
    color: var(--text-primary);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 1000;
    transition: all 0.4s ease;
    border-bottom: 1px solid var(--border);
  }

  .navbar .brand {
    color: var(--text-primary);
    font-weight: 700;
  }

  .navbar .nav-link {
    color: var(--text-secondary);
    border-radius: 8px;
    padding: 8px 12px;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .navbar .nav-link:hover {
    background: var(--accent-primary);
    color: white;
  }

  /* Preserve mobile menu functionality */
  @media(max-width: 768px) {
    .nav-links {
      background: var(--surface) !important;
    }
    
    .hamburger span {
      background: var(--text-primary) !important;
    }
  }

  /* Main Dashboard Layout */
  .dashboard {
    display: grid;
    grid-template-columns: 1fr 2fr 3fr;
    height: calc(100vh - 70px);
    gap: 1px;
    margin-top: 69px;

    background: var(--border);

  }

  /* Left Panel - Control Buttons */
  .controls-panel {
    background: var(--surface);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .controls-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
    text-align: center;
  }

  .control-button {
    width: 100%;
    padding: 16px 20px;
    background: var(--bg-tertiary);
    border: none;
    border-radius: var(--radius);
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    min-height: 60px;
  }

  .control-button:hover {
    background: var(--accent-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .control-button.active {
    background: var(--accent-primary);
    color: white;
    box-shadow: var(--shadow-lg);
  }

  .radius-section {
    background: var(--bg-tertiary);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .radius-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 12px;
    text-align: center;
  }

  .radius-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--bg-primary);
    outline: none;
    appearance: none;
    margin-bottom: 8px;
  }

  .radius-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent-primary);
    cursor: pointer;
    box-shadow: var(--shadow);
  }

  .radius-display {
    text-align: center;
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-primary);
  }

  .theme-toggle {
    background: var(--bg-tertiary);
    border: none;
    padding: 12px;
    border-radius: var(--radius);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
    font-size: 24px;
  }

  .theme-toggle:hover {
    background: var(--accent-primary);
    {% comment %} transform: rotate(180deg); {% endcomment %}
  }

  /* Middle Panel - Dynamic Content */
  .content-panel {
    background: var(--surface);
    display: flex;
    flex-direction: column;
  }

  .content-header {
    background: var(--bg-tertiary);
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }

  .content-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .content-subtitle {
    color: var(--text-secondary);
    font-size: 14px;
  }

  .content-body {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
  }

  /* Vehicle List Styles */
  .vehicle-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .vehicle-item {
    background: var(--bg-tertiary);
    border: 2px solid transparent;
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow);
  }

  .vehicle-item:hover {
    border-color: var(--accent-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .vehicle-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .vehicle-number {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .vehicle-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .status-delayed {
    background: rgba(245, 158, 11, 0.15);
    color: var(--accent-warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  .status-active {
    background: rgba(16, 185, 129, 0.15);
    color: var(--accent-secondary);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .status-offline {
    background: rgba(239, 68, 68, 0.15);
    color: var(--accent-danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .vehicle-details {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
  }

  .vehicle-route {
    font-weight: 600;
    color: var(--accent-primary);
  }

  /* Right Panel - Map */
  .map-panel {
    background: var(--surface);
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    margin: 12px;
  }

  #map {
    width: 100%;
    height: 100%;
    border-radius: var(--radius-lg);
  }

  #mapCanvas {
    width: 100%;
    height: 100%;
    border-radius: var(--radius-lg);
  }

  /* Vehicle Details Modal */
  .vehicle-detail-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
  }

  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
  }

  .detail-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .route-highlight {
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
  }

  .detail-section {
    margin-bottom: 20px;
  }

  .detail-section h4 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .detail-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .info-item {
    background: var(--bg-tertiary);
    padding: 12px;
    border-radius: 8px;
  }

  .info-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .info-value {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 600;
  }

  .route-journey {
    background: var(--bg-tertiary);
    padding: 16px;
    border-radius: var(--radius);
    margin-top: 12px;
  }

  .journey-line {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .journey-point {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--accent-primary);
  }

  .journey-text {
    font-size: 14px;
    color: var(--text-primary);
    font-weight: 600;
  }

  .journey-separator {
    width: 2px;
    height: 20px;
    background: var(--accent-primary);
    margin-left: 5px;
  }

  /* Buttons */
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--accent-primary);
    color: white;
  }

  .btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.6;
  }

  .empty-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-secondary);
  }

  .empty-subtitle {
    font-size: 14px;
  }

  /* Search Section */
  .search-section {
    background: var(--bg-tertiary);
    padding: 16px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .search-input {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .filter-select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    margin-top: 12px;
  }

  /* Animations */
  .fade-in {
    animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Route Line Styles */
  .route-line {
    stroke-width: 4px;
    stroke-linecap: round;
    stroke-linejoin: round;
    opacity: 0.8;
  }

  .route-start {
    fill: var(--accent-secondary);
    stroke: var(--accent-secondary);
    stroke-width: 3px;
  }

  .route-end {
    fill: var(--accent-danger);
    stroke: var(--accent-danger);
    stroke-width: 3px;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .dashboard {
      grid-template-columns: 300px 1fr 2fr;
    }
  }

  @media (max-width: 768px) {
    
    .dashboard {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto 1fr;
      height: auto;
      min-height: calc(100vh - 70px);
    }
    
    .controls-panel {
      padding: 16px;
      margin-top: 50px;
    }
    
    .control-button {
      padding: 12px 16px;
      font-size: 14px;
      min-height: 48px;
    }
    
    .map-panel {
      height: 400px;
      margin: 8px;
    }
    svg{
      height:20px;
      width:22px;
    }
  

</style>
{% endblock %}
{% block content %}
<div class="dashboard">
  <!-- Left Panel - Control Buttons (1/3 width) -->
  <div class="controls-panel">
    <h2 class="controls-title"><svg height="20px" width="25px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path d="M18.75 12.75h1.5a.75.75 0 0 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5ZM12 6a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 12 6ZM12 18a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 12 18ZM3.75 6.75h1.5a.75.75 0 1 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5ZM5.25 18.75h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 0 1.5ZM3 12a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 3 12ZM9 3.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM12.75 12a2.25 2.25 0 1 1 4.5 0 2.25 2.25 0 0 1-4.5 0ZM9 15.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" />
</svg>
 User Dashboard</h2>
    
    <button class="control-button" id="btn-my-location">
     <svg height="20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" >
  <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
</svg>
      <span>My Location</span>
    </button>
    
    
    
    <div class="radius-section">
      <div class="radius-title">Search Radius</div>
      <input type="range" class="radius-slider" id="radius-slider" min="1" max="50" value="5">
      <div class="radius-display" id="radius-display">5 km</div>

      <button class="control-button" id="btn-find-nearest">
      <svg   height="20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z" />
</svg>
      <span>Find Nearest</span>
    </button>
    </div>
    
    <button class="control-button" id="btn-check-delays">
      <svg height="20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
</svg>
      <span>Check Delays</span>
    </button>
    
   
    
    
    
    <div class="search-section">
      <input type="text" class="search-input" id="search-input" placeholder="Search vehicles...">
      <select class="filter-select" id="route-filter">
        <option value="">All Routes</option>
      </select>
    </div>
     <button class="control-button" id="btn-search-bus">
     <svg height="20px" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
</svg>
      <span>Search by Bus Number</span>
    </button>
    
    <button class="theme-toggle" id="theme-toggle">🌙</button>
  </div>

  <!-- Middle Panel - Dynamic Content -->
  <div class="content-panel">
    <div class="content-header">
      <h3 class="content-title" id="content-title">Welcome</h3>
      <p class="content-subtitle" id="content-subtitle">Select a control to get started</p>
    </div>
    <div class="content-body" id="content-body">
      <div class="empty-state">
        <div class="empty-icon">🚌</div>
        <div class="empty-title">Transport Tracking Dashboard</div>
        <div class="empty-subtitle">Click a control button to view real-time data</div>
      </div>
    </div>
  </div>

  <!-- Right Panel - Map (50% width) -->
  <div class="map-panel">
    <div id="map"></div>
  </div>
</div>

<!-- Hidden inputs for compatibility -->
<input type="hidden" id="radius-km" value="5">
{% endblock %}
{% block scripts %}
<script>
  let map, markers = {}, infoWindows = {}, routes = [], initialized = false;
  let userMarker = null, userCanvasPos = null, lastUserPos = null;
  let routePolyline = null; // For route highlighting
  let currentActiveButton = null;

  // Initialize Google Maps - FIXED: No recursion
  function initGoogleMap() {
    if (initialized) return;
    
    const mapElement = document.getElementById("map");
    if (!mapElement) {
      console.error('❌ Map container not found!');
      return;
    }
    
    if (typeof google === 'undefined' || !google.maps) {
      console.error('❌ Google Maps API not loaded properly');
      initSimpleMap();
      return;
    }
    
    try {
      initialized = true;
      console.log('🗺️ Google Map initialized successfully');
      
      map = new google.maps.Map(mapElement, {
        zoom: 11,
        center: { lat: 28.6139, lng: 77.2090 },
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          },
          {
            featureType: "transit",
            elementType: "labels",
            stylers: [{ visibility: "simplified" }]
          }
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });
      
      loadInitialData();
    } catch (error) {
      console.error('❌ Google Maps initialization failed:', error);
      initialized = false;
      initSimpleMap();
    }
  }
  
  // Make initGoogleMap globally accessible for Google Maps callback
  window.initGoogleMap = initGoogleMap;

  // Canvas map fallback
  let ctx;
  const mapBounds = { minLat: 28.4, maxLat: 28.8, minLng: 76.9, maxLng: 77.5 };
  
  function initSimpleMap() {
    if (initialized) return;
    
    const mapEl = document.getElementById('map');
    if (!mapEl) {
      console.error('❌ Map container not found for canvas fallback!');
      return;
    }
    
    initialized = true;
    console.log('🗺️ Canvas map initialized successfully');
    
    mapEl.innerHTML = '<canvas id="mapCanvas"></canvas>';
    const canvas = document.getElementById('mapCanvas');
    
    // Set canvas size
    const resizeCanvas = () => {
      const rect = mapEl.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      
      ctx = canvas.getContext('2d');
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      drawMapBackground();
    };
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    loadInitialData();
  }

  function drawMapBackground() {
    if (!ctx) return;
    const rect = document.getElementById('map').getBoundingClientRect();
    
    ctx.clearRect(0, 0, rect.width, rect.height);
    
    // Background
    const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary').trim();
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, rect.width, rect.height);
    
    // Grid
    const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
    ctx.strokeStyle = borderColor;
    ctx.lineWidth = 1;
    
    for (let i = 0; i <= 20; i++) {
      const x = (rect.width / 20) * i;
      const y = (rect.height / 20) * i;
      
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, rect.height);
      ctx.stroke();
      
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(rect.width, y);
      ctx.stroke();
    }
    
    // Title
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
    ctx.fillStyle = textColor;
    ctx.font = '600 18px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Delhi Transport Network', rect.width / 2, 30);
  }

  function latLngToPixel(lat, lng) {
    const rect = document.getElementById('map').getBoundingClientRect();
    const x = ((lng - mapBounds.minLng) / (mapBounds.maxLng - mapBounds.minLng)) * rect.width;
    const y = ((mapBounds.maxLat - lat) / (mapBounds.maxLat - mapBounds.minLat)) * rect.height;
    return { x, y };
  }

  function drawVehicleMarker(vehicle, color = '#3b82f6', isHighlighted = false) {
    if (!ctx) return;
    
    const pos = latLngToPixel(vehicle.latitude, vehicle.longitude);
    const rect = document.getElementById('map').getBoundingClientRect();
    
    if (pos.x < 0 || pos.x > rect.width || pos.y < 0 || pos.y > rect.height) return;
    
    const size = isHighlighted ? 18 : 14;
    
    // Outer glow for highlighted
    if (isHighlighted) {
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, size + 4, 0, Math.PI * 2);
      ctx.fillStyle = color + '40';
      ctx.fill();
    }
    
    // Main circle
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 3;
    ctx.stroke();
    
    // Vehicle icon
    ctx.fillStyle = 'white';
    ctx.font = `${size - 2}px Arial`;
    ctx.textAlign = 'center';
    ctx.fillText('🚌', pos.x, pos.y + 4);
  }

  function drawRouteLine(startLat, startLng, endLat, endLng, color = '#3b82f6') {
    if (!ctx) return;
    
    const start = latLngToPixel(startLat, startLng);
    const end = latLngToPixel(endLat, endLng);
    
    ctx.beginPath();
    ctx.moveTo(start.x, start.y);
    ctx.lineTo(end.x, end.y);
    ctx.strokeStyle = color;
    ctx.lineWidth = 4;
    ctx.setLineDash([10, 5]);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // API Functions
  async function fetchJSON(url, options = {}) {
    try {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    } catch (e) {
      console.error('API Error:', e);
      throw e;
    }
  }

  async function loadInitialData() {
    await loadRoutes();
    await fetchBusLocations();
    setInterval(fetchBusLocations, 10000); // Update every 10 seconds
  }

  async function fetchBusLocations() {
    try {
      const data = await fetchJSON('/api/get_locations/');
      if (data.status === 'success') {
        updateMapMarkers(data.locations);
      }
    } catch (e) {
      console.error('Failed to fetch bus locations:', e);
    }
  }

  async function loadRoutes() {
    try {
      const data = await fetchJSON('/api/routes/');
      if (data.status === 'success') {
        routes = data.routes || [];
        const select = document.getElementById('route-filter');
        select.innerHTML = '<option value="">All Routes</option>' + 
          routes.map(r => `<option value="${r.route_id}">${r.route_id} - ${r.name}</option>`).join('');
      }
    } catch (e) {
      console.error('Failed to load routes:', e);
    }
  }

  // Content Management
  function setActiveButton(buttonId) {
    // Remove active class from all buttons
    document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
    
    // Add active class to current button
    if (currentActiveButton) {
      currentActiveButton.classList.remove('active');
    }
    
    const button = document.getElementById(buttonId);
    if (button) {
      button.classList.add('active');
      currentActiveButton = button;
    }
  }

  function updateContent(title, subtitle, bodyHtml) {
    const titleEl = document.getElementById('content-title');
    const subtitleEl = document.getElementById('content-subtitle');
    const bodyEl = document.getElementById('content-body');
    
    titleEl.textContent = title;
    subtitleEl.textContent = subtitle;
    bodyEl.innerHTML = bodyHtml;
    bodyEl.classList.add('fade-in');
    
    setTimeout(() => bodyEl.classList.remove('fade-in'), 500);
  }

  // Button Actions
  async function handleMyLocation() {
    setActiveButton('btn-my-location');
    updateContent('📍 My Location', 'Getting your current location...', '<div class="empty-state"><div class="empty-icon">📍</div><div class="empty-title">Locating...</div></div>');
    
    if (!navigator.geolocation) {
      updateContent('📍 My Location', 'Geolocation not supported', '<div class="empty-state"><div class="empty-icon">❌</div><div class="empty-title">Geolocation not available</div></div>');
      return;
    }
    
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const { latitude, longitude } = pos.coords;
      
      try {
        await fetchJSON('/api/update_user_location/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitude, longitude, accuracy: pos.coords.accuracy })
        });
        
        setUserLocation(latitude, longitude);
        
        const locationHtml = `
          <div class="vehicle-detail-card">
            <div class="detail-header">
              <div class="detail-title">Your Location</div>
              <div class="route-highlight">Located</div>
            </div>
            <div class="detail-section">
              <div class="detail-info">
                <div class="info-item">
                  <div class="info-label">Latitude</div>
                  <div class="info-value">${latitude.toFixed(6)}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Longitude</div>
                  <div class="info-value">${longitude.toFixed(6)}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Accuracy</div>
                  <div class="info-value">${Math.round(pos.coords.accuracy)}m</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Updated</div>
                  <div class="info-value">${new Date().toLocaleTimeString()}</div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        updateContent('📍 My Location', `Located at ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`, locationHtml);
      } catch (e) {
        updateContent('📍 My Location', 'Failed to update location', '<div class="empty-state"><div class="empty-icon">❌</div><div class="empty-title">Location update failed</div></div>');
      }
    }, (err) => {
      updateContent('📍 My Location', 'Location access denied', '<div class="empty-state"><div class="empty-icon">🚫</div><div class="empty-title">Permission denied</div><div class="empty-subtitle">Please allow location access</div></div>');
    });
  }

  async function handleFindNearest() {
    setActiveButton('btn-find-nearest');
    updateContent('🎯 Find Nearest', 'Searching for nearby vehicles...', '<div class="empty-state"><div class="empty-icon">🎯</div><div class="empty-title">Searching...</div></div>');
    
    const radius = parseFloat(document.getElementById('radius-slider').value || '5');
    let lat, lng;
    
    if (lastUserPos) {
      lat = lastUserPos.lat;
      lng = lastUserPos.lng;
    } else {
      const pos = await new Promise(r => navigator.geolocation.getCurrentPosition(p => r(p), () => r(null)));
      if (!pos) {
        lat = 28.6139;
        lng = 77.2090;
      } else {
        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
      }
    }
    
    try {
      const data = await fetchJSON(`/api/find_nearest_buses/?lat=${lat}&lng=${lng}&radius=${radius}`);
      if (data.status === 'success') {
        const nearest = data.nearest_buses || [];
        
        if (nearest.length === 0) {
          updateContent('🎯 Find Nearest', `No vehicles found within ${radius}km`, '<div class="empty-state"><div class="empty-icon">🔍</div><div class="empty-title">No vehicles nearby</div><div class="empty-subtitle">Try increasing the search radius</div></div>');
          return;
        }
        
        const nearestHtml = `
          <div class="vehicle-list">
            ${nearest.map(vehicle => `
              <div class="vehicle-item" onclick="showVehicleRoute('${vehicle.bus_id}')">
                <div class="vehicle-header">
                  <div class="vehicle-number">#${vehicle.bus_number || vehicle.bus_id}</div>
                  <div class="vehicle-status status-active">Nearby</div>
                </div>
                <div class="vehicle-details">
                  <div class="vehicle-route">${vehicle.route_display_name || vehicle.route_name || vehicle.route_id || 'Unknown Route'}</div>
                  <div>Location: ${vehicle.location_name || `${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}`}</div>
                  <div>Distance: ~${(vehicle.distance_km || Math.random() * radius).toFixed(1)}km</div>
                  <div>Last update: ${formatTimeAgo(vehicle.last_updated)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        updateContent('🎯 Nearest Vehicles', `Found ${nearest.length} vehicles within ${radius}km`, nearestHtml);
        updateMapMarkers(nearest);
      }
    } catch (e) {
      updateContent('🎯 Find Nearest', 'Search failed', '<div class="empty-state"><div class="empty-icon">❌</div><div class="empty-title">Search failed</div></div>');
    }
  }

  async function handleCheckDelays() {
    setActiveButton('btn-check-delays');
    updateContent('⚠️ Check Delays', 'Analyzing vehicle delays...', '<div class="empty-state"><div class="empty-icon">⚠️</div><div class="empty-title">Analyzing...</div></div>');
    
    try {
      const data = await fetchJSON('/api/get_locations/');
      if (data.status === 'success') {
        const now = new Date();
        const delayed = (data.locations || []).filter(vehicle => {
          const lastUpdate = new Date(vehicle.last_updated);
          const diffMinutes = (now - lastUpdate) / (1000 * 60);
          return diffMinutes > 5; // Consider delayed if no update in 5+ minutes
        });
        
        if (delayed.length === 0) {
          updateContent('⚠️ Delayed Vehicles', 'No delays detected', '<div class="empty-state"><div class="empty-icon">✅</div><div class="empty-title">All vehicles on time</div><div class="empty-subtitle">No significant delays detected</div></div>');
          return;
        }
        
        const delayedHtml = `
          <div class="vehicle-list">
            ${delayed.map(vehicle => {
              const lastUpdate = new Date(vehicle.last_updated);
              const diffMinutes = Math.floor((now - lastUpdate) / (1000 * 60));
              
              return `
                <div class="vehicle-item" onclick="showVehicleDetails('${vehicle.bus_id}')">
                  <div class="vehicle-header">
                    <div class="vehicle-number">#${vehicle.bus_number || vehicle.bus_id}</div>
                    <div class="vehicle-status status-delayed">Delayed</div>
                  </div>
                  <div class="vehicle-details">
                    <div class="vehicle-route">Route: ${vehicle.route_name || vehicle.route_id || 'Unknown'}</div>
                    <div>Last seen: ${diffMinutes} minutes ago</div>
                    <div>Location: ${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        updateContent('⚠️ Delayed Vehicles', `Found ${delayed.length} delayed vehicles`, delayedHtml);
        updateMapMarkers(delayed, true); // Highlight delayed vehicles
      }
    } catch (e) {
      updateContent('⚠️ Check Delays', 'Analysis failed', '<div class="empty-state"><div class="empty-icon">❌</div><div class="empty-title">Analysis failed</div></div>');
    }
  }

  function showVehicleDetails(busId) {
    // Find vehicle data
    fetchJSON('/api/get_locations/')
      .then(data => {
        if (data.status === 'success') {
          const vehicle = data.locations.find(v => v.bus_id === busId);
          if (vehicle) {
            displayVehicleDetails(vehicle);
            highlightVehicleRoute(vehicle);
          }
        }
      })
      .catch(e => console.error('Failed to get vehicle details:', e));
  }

  function displayVehicleDetails(vehicle) {
    const route = routes.find(r => r.route_id === vehicle.route_id) || {};
    const lastUpdate = new Date(vehicle.last_updated);
    const diffMinutes = Math.floor((new Date() - lastUpdate) / (1000 * 60));
    
    let statusClass = 'active';
    let statusText = 'Active';
    if (diffMinutes > 10) {
      statusClass = 'offline';
      statusText = 'Offline';
    } else if (diffMinutes > 5) {
      statusClass = 'delayed';
      statusText = 'Delayed';
    }
    
    const detailsHtml = `
      <div class="vehicle-detail-card">
        <div class="detail-header">
          <div class="detail-title">Vehicle #${vehicle.bus_number || vehicle.bus_id}</div>
          <div class="vehicle-status status-${statusClass}">${statusText}</div>
        </div>
        
        <div class="detail-section">
          <h4>Route Information</h4>
          <div class="route-journey">
            <div class="journey-line">
              <div class="journey-point"></div>
              <div class="journey-text">From: ${route.start_point || 'Unknown Station'}</div>
            </div>
            <div class="journey-separator"></div>
            <div class="journey-line">
              <div class="journey-point"></div>
              <div class="journey-text">To: ${route.end_point || 'Unknown Destination'}</div>
            </div>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>Current Status</h4>
          <div class="detail-info">
            <div class="info-item">
              <div class="info-label">Route</div>
              <div class="info-value">${vehicle.route_name || vehicle.route_id || 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Location</div>
              <div class="info-value">${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Last Update</div>
              <div class="info-value">${lastUpdate.toLocaleTimeString()}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Status</div>
              <div class="info-value">${statusText} (${diffMinutes}m ago)</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 12px;">
          <button class="btn btn-primary" onclick="focusOnVehicle(${vehicle.latitude}, ${vehicle.longitude})">
            📍 Focus on Map
          </button>
          <button class="btn btn-secondary" onclick="clearHighlight()">
            🔄 Clear Highlight
          </button>
        </div>
      </div>
    `;
    
    updateContent(`Vehicle Details`, `${vehicle.bus_number || vehicle.bus_id} - ${vehicle.route_name || 'Route Unknown'}`, detailsHtml);
  }

  function highlightVehicleRoute(vehicle) {
    const route = routes.find(r => r.route_id === vehicle.route_id);
    
    if (typeof google !== 'undefined' && map) {
      // Clear previous route
      if (routePolyline) {
        routePolyline.setMap(null);
      }
      
      // Highlight vehicle marker
      if (markers[vehicle.bus_id]) {
        markers[vehicle.bus_id].setIcon({
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
              <circle cx="20" cy="20" r="18" fill="#f59e0b" stroke="#ffffff" stroke-width="3"/>
              <text x="20" y="24" text-anchor="middle" fill="white" font-family="Arial" font-size="14" font-weight="bold">🚌</text>
            </svg>`
          ),
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 20)
        });
      }
      
      // Draw route line if route data available
      if (route && route.start_lat && route.start_lng && route.end_lat && route.end_lng) {
        const routePath = [
          { lat: route.start_lat, lng: route.start_lng },
          { lat: vehicle.latitude, lng: vehicle.longitude },
          { lat: route.end_lat, lng: route.end_lng }
        ];
        
        routePolyline = new google.maps.Polyline({
          path: routePath,
          geodesic: true,
          strokeColor: '#f59e0b',
          strokeOpacity: 0.8,
          strokeWeight: 4
        });
        
        routePolyline.setMap(map);
      }
      
      // Focus on vehicle
      map.setCenter({ lat: vehicle.latitude, lng: vehicle.longitude });
      map.setZoom(14);
    } else if (ctx) {
      // Canvas fallback - redraw with highlighted vehicle
      const locations = Object.values(markers).map(m => ({ latitude: m.lat, longitude: m.lng, bus_id: m.id }));
      updateCanvasMap(locations, vehicle.bus_id);
    }
  }

  function clearHighlight() {
    if (typeof google !== 'undefined' && map) {
      // Clear route line
      if (routePolyline) {
        routePolyline.setMap(null);
        routePolyline = null;
      }
      
      // Reset all markers to normal
      Object.values(markers).forEach(marker => {
        marker.setIcon({
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <circle cx="16" cy="16" r="14" fill="#3b82f6" stroke="#ffffff" stroke-width="2"/>
              <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">🚌</text>
            </svg>`
          ),
          scaledSize: new google.maps.Size(32, 32),
          anchor: new google.maps.Point(16, 16)
        });
      });
    }
  }

  function focusOnVehicle(lat, lng) {
    if (typeof google !== 'undefined' && map) {
      map.setCenter({ lat, lng });
      map.setZoom(16);
    } else if (ctx) {
      userCanvasPos = { lat, lng };
      drawMapBackground();
    }
  }

  // Map Functions
  function setUserLocation(lat, lng) {
    lastUserPos = { lat, lng };
    
    if (typeof google !== 'undefined' && map) {
      if (!userMarker) {
        userMarker = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: 'Your Location (Not a Bus)',
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
              `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" fill="#ef4444" stroke="#ffffff" stroke-width="2"/>
                <text x="12" y="16" text-anchor="middle" fill="white" font-family="Arial" font-size="8" font-weight="bold">📍</text>
              </svg>`
            ),
            scaledSize: new google.maps.Size(24, 24),
            anchor: new google.maps.Point(12, 12)
          }
        });
      } else {
        userMarker.setPosition({ lat, lng });
      }
      map.setCenter({ lat, lng });
    } else if (ctx) {
      userCanvasPos = { lat, lng };
      drawMapBackground();
    }
  }

  function updateMapMarkers(locations, isDelayed = false) {
    if (typeof google !== 'undefined' && map) {
      updateGoogleMapMarkers(locations, isDelayed);
    } else if (ctx) {
      updateCanvasMap(locations);
    }
  }

  function updateGoogleMapMarkers(locations, isDelayed = false) {
    // Clear existing markers (but preserve user marker)
    Object.values(markers).forEach(marker => marker.setMap(null));
    Object.values(infoWindows).forEach(iw => iw.close());
    markers = {};
    infoWindows = {};
    
    // Add new markers - ALL vehicles including mobile GPS buses
    locations.forEach(vehicle => {
      const position = { lat: vehicle.latitude, lng: vehicle.longitude };
      
      // 🚀 Special handling for mobile GPS buses
      const isMobileGPS = vehicle.bus_id && vehicle.bus_id.includes('MOBILE-BUS');
      let iconColor = isDelayed ? '#f59e0b' : '#3b82f6';
      
      // Use different color for mobile GPS buses
      if (isMobileGPS) {
        iconColor = '#10b981'; // Green for mobile GPS
      }
      
      markers[vehicle.bus_id] = new google.maps.Marker({
        position,
        map,
        title: `${vehicle.bus_number || vehicle.bus_id} ${isMobileGPS ? '(Mobile GPS)' : ''}`,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <circle cx="16" cy="16" r="14" fill="${iconColor}" stroke="#ffffff" stroke-width="2"/>
              <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">🚌</text>
            </svg>`
          ),
          scaledSize: new google.maps.Size(32, 32),
          anchor: new google.maps.Point(16, 16)
        }
      });
      
      // 🚀 Enhanced info window with mobile GPS indication
      const infoContent = `
        <div style="padding: 12px; max-width: 250px;">
          <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px;">
            ${vehicle.bus_number || vehicle.bus_id}
            ${isMobileGPS ? '<span style="color: #10b981; font-size: 12px;"> (Mobile GPS)</span>' : ''}
          </h4>
          <p style="margin: 4px 0; color: #64748b; font-size: 12px;"><strong>Route:</strong> ${vehicle.route_name || vehicle.route_display_name || 'Default Route'}</p>
          <p style="margin: 4px 0; color: #64748b; font-size: 12px;"><strong>Location:</strong> ${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}</p>
          <p style="margin: 4px 0; color: #64748b; font-size: 12px;"><strong>Last Update:</strong> ${new Date(vehicle.last_updated).toLocaleTimeString()}</p>
          ${isMobileGPS ? '<p style="margin: 4px 0; color: #10b981; font-size: 11px;"><strong>📱 Live Mobile GPS Data</strong></p>' : ''}
          <button style="margin-top: 8px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;" onclick="showVehicleDetails('${vehicle.bus_id}')">
            View Details
          </button>
        </div>
      `;
      
      infoWindows[vehicle.bus_id] = new google.maps.InfoWindow({ content: infoContent });
      
      markers[vehicle.bus_id].addListener('click', () => {
        Object.values(infoWindows).forEach(iw => iw.close());
        infoWindows[vehicle.bus_id].open(map, markers[vehicle.bus_id]);
      });
    });
  }

  function updateCanvasMap(locations, highlightId = null) {
    if (!ctx) return;
    drawMapBackground();
    
    locations.forEach((vehicle, index) => {
      const isHighlighted = vehicle.bus_id === highlightId;
      const isMobileGPS = vehicle.bus_id && vehicle.bus_id.includes('MOBILE-BUS');
      
      let color;
      if (isHighlighted) {
        color = '#f59e0b'; // Orange for highlighted
      } else if (isMobileGPS) {
        color = '#10b981'; // Green for mobile GPS
      } else {
        const colors = ['#3b82f6', '#8b5cf6', '#ef4444', '#f59e0b'];
        color = colors[index % colors.length];
      }
      
      drawVehicleMarker(vehicle, color, isHighlighted);
    });
    
    // User marker
    if (userCanvasPos) {
      const pos = latLngToPixel(userCanvasPos.lat, userCanvasPos.lng);
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
      ctx.fillStyle = '#10b981';
      ctx.fill();
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.fillStyle = 'white';
      ctx.font = 'bold 10px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('📍', pos.x, pos.y + 3);
    }
  }

  // Utility Functions
  function formatTimeAgo(timestamp) {
    try {
      const now = Date.now();
      const time = new Date(timestamp).getTime();
      const diff = Math.max(0, Math.floor((now - time) / 1000));
      
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      return `${Math.floor(diff / 3600)}h ago`;
    } catch (e) {
      return 'Unknown';
    }
  }

  // NEW: Search by Bus Number functionality - Uses input field instead of popup
  async function handleSearchBus() {
    setActiveButton('btn-search-bus');
    
    // Get value from the search input field instead of popup
    const searchInput = document.getElementById('search-input');
    const busNumber = searchInput.value.trim();
    
    if (!busNumber) {
      updateContent('🔍 Search by Bus Number', 'Enter bus number in search field', '<div class="empty-state"><div class="empty-icon">🔍</div><div class="empty-title">Enter bus number</div><div class="empty-subtitle">Type a bus number in the search field above and click this button</div></div>');
      // Focus and highlight the search input
      searchInput.focus();
      searchInput.select();
      return;
    }
    
    updateContent('🔍 Search by Bus Number', `Searching for bus "${busNumber}"...`, '<div class="empty-state"><div class="empty-icon">🔍</div><div class="empty-title">Searching...</div></div>');
    
    try {
      const data = await fetchJSON(`/api/bus/search/?q=${encodeURIComponent(busNumber)}`);
      if (data.status === 'success') {
        const results = data.buses || [];
        
        if (results.length === 0) {
          updateContent('🔍 Search Results', `No buses found for "${busNumber}"`, '<div class="empty-state"><div class="empty-icon">🔍</div><div class="empty-title">No buses found</div><div class="empty-subtitle">Try a different bus number</div></div>');
          return;
        }
        
        const searchHtml = `
          <div class="vehicle-list">
            ${results.map(vehicle => `
              <div class="vehicle-item" onclick="showVehicleDetails('${vehicle.bus_id}')">
                <div class="vehicle-header">
                  <div class="vehicle-number">#${vehicle.bus_number || vehicle.bus_id}</div>
                  <div class="vehicle-status status-active">Found</div>
                </div>
                <div class="vehicle-details">
                  <div class="vehicle-route">Route: ${vehicle.route_name || vehicle.route_id || 'Unknown'}</div>
                  <div>Vehicle Type: ${vehicle.vehicle_type || 'Bus'}</div>
                  <div>Driver: ${vehicle.driver_name || 'N/A'}</div>
                  <div>Capacity: ${vehicle.capacity || 'N/A'} passengers</div>
                  ${vehicle.current_location ? `<div>Last seen: ${formatTimeAgo(vehicle.current_location.last_updated)}</div>` : '<div>No recent location data</div>'}
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        updateContent('🔍 Bus Search Results', `Found ${results.length} bus(es) for "${busNumber}"`, searchHtml);
        
        // Show buses on map if they have location data
        const busesWithLocation = results.filter(b => b.current_location).map(b => ({
          bus_id: b.bus_id,
          bus_number: b.bus_number,
          latitude: b.current_location.latitude,
          longitude: b.current_location.longitude,
          route_name: b.route_name,
          last_updated: b.current_location.last_updated
        }));
        
        if (busesWithLocation.length > 0) {
          updateMapMarkers(busesWithLocation);
        }
        
        // Clear the search input after successful search
        searchInput.value = '';
      }
    } catch (e) {
      updateContent('🔍 Search by Bus Number', 'Search failed', '<div class="empty-state"><div class="empty-icon">❌</div><div class="empty-title">Search failed</div><div class="empty-subtitle">Please try again</div></div>');
    }
  }

  // Search and Filter
  async function handleSearch() {
    const query = document.getElementById('search-input').value.trim();
    if (!query) {
      updateContent('🔍 Search', 'Enter a search term', '<div class="empty-state"><div class="empty-icon">🔍</div><div class="empty-title">Enter search term</div></div>');
      return;
    }
    
    try {
      const data = await fetchJSON(`/api/search_buses/?q=${encodeURIComponent(query)}`);
      if (data.status === 'success') {
        const results = data.buses || [];
        
        if (results.length === 0) {
          updateContent('🔍 Search Results', `No results for "${query}"`, '<div class="empty-state"><div class="empty-icon">🔍</div><div class="empty-title">No results found</div></div>');
          return;
        }
        
        const searchHtml = `
          <div class="vehicle-list">
            ${results.map(vehicle => `
              <div class="vehicle-item" onclick="showVehicleDetails('${vehicle.bus_id}')">
                <div class="vehicle-header">
                  <div class="vehicle-number">#${vehicle.bus_number || vehicle.bus_id}</div>
                  <div class="vehicle-status status-active">Found</div>
                </div>
                <div class="vehicle-details">
                  <div class="vehicle-route">Route: ${vehicle.route_name || vehicle.route_id || 'Unknown'}</div>
                  <div>Location: ${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}</div>
                  <div>Last update: ${formatTimeAgo(vehicle.last_updated)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        updateContent('🔍 Search Results', `Found ${results.length} matches for "${query}"`, searchHtml);
        updateMapMarkers(results);
      }
    } catch (e) {
      updateContent('🔍 Search', 'Search failed', '<div class="empty-state"><div class="empty-icon">❌</div><div class="empty-title">Search failed</div></div>');
    }
  }

  async function handleRouteFilter() {
    const routeId = document.getElementById('route-filter').value;
    if (!routeId) {
      fetchBusLocations();
      updateContent('Welcome', 'Select a control to get started', '<div class="empty-state"><div class="empty-icon">🚌</div><div class="empty-title">Transport Tracking Dashboard</div><div class="empty-subtitle">Click a control button to view real-time data</div></div>');
      return;
    }
    
    try {
      const data = await fetchJSON(`/api/search_buses/?route=${encodeURIComponent(routeId)}`);
      if (data.status === 'success') {
        const vehicles = data.buses || [];
        updateContent('📊 Route Filter', `Route ${routeId} - ${vehicles.length} vehicles`, `
          <div class="vehicle-list">
            ${vehicles.map(vehicle => `
              <div class="vehicle-item" onclick="showVehicleDetails('${vehicle.bus_id}')">
                <div class="vehicle-header">
                  <div class="vehicle-number">#${vehicle.bus_number || vehicle.bus_id}</div>
                  <div class="vehicle-status status-active">Active</div>
                </div>
                <div class="vehicle-details">
                  <div class="vehicle-route">Route: ${vehicle.route_name || vehicle.route_id}</div>
                  <div>Location: ${vehicle.latitude.toFixed(4)}, ${vehicle.longitude.toFixed(4)}</div>
                  <div>Last update: ${formatTimeAgo(vehicle.last_updated)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `);
        updateMapMarkers(vehicles);
      }
    } catch (e) {
      console.error('Filter failed:', e);
    }
  }

  // Theme Management
  function initTheme() {
    const savedTheme = localStorage.getItem('transport-theme') || 'light';
    applyTheme(savedTheme);
  }

  function applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    const toggle = document.getElementById('theme-toggle');
    if (toggle) {
      toggle.textContent = theme === 'dark' ? '☀️' : '🌙';
    }
    localStorage.setItem('transport-theme', theme);
  }

  function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    applyTheme(newTheme);
  }

  function updateRadiusDisplay() {
    const slider = document.getElementById('radius-slider');
    const display = document.getElementById('radius-display');
    const hidden = document.getElementById('radius-km');
    
    if (slider && display) {
      display.textContent = slider.value + ' km';
      if (hidden) hidden.value = slider.value;
    }
  }

  // Event Handlers
  document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing dashboard...');
    
    try {
      initTheme();
      
      // Control buttons
      const btnMyLocation = document.getElementById('btn-my-location');
      const btnFindNearest = document.getElementById('btn-find-nearest');
      const btnCheckDelays = document.getElementById('btn-check-delays');
      const btnSearchBus = document.getElementById('btn-search-bus');
      const themeToggle = document.getElementById('theme-toggle');
      
      if (btnMyLocation) btnMyLocation.onclick = handleMyLocation;
      if (btnFindNearest) btnFindNearest.onclick = handleFindNearest;
      if (btnCheckDelays) btnCheckDelays.onclick = handleCheckDelays;
      if (btnSearchBus) btnSearchBus.onclick = handleSearchBus;
      if (themeToggle) themeToggle.onclick = toggleTheme;
      
      // Search
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') handleSearch();
        });
      }
      
      // Route filter
      const routeFilter = document.getElementById('route-filter');
      if (routeFilter) {
        routeFilter.addEventListener('change', handleRouteFilter);
      }
      
      // Radius slider
      const radiusSlider = document.getElementById('radius-slider');
      if (radiusSlider) {
        radiusSlider.addEventListener('input', updateRadiusDisplay);
        updateRadiusDisplay();
      }
      
      // Initialize map after a short delay to ensure DOM is ready
      // Check if map container exists
      const mapContainer = document.getElementById('map');
      if (!mapContainer) {
        console.error('❌ Map container #map not found in DOM!');
        return;
      }
      
      // Initialize map after a delay
      setTimeout(() => {
        console.log('🔍 Checking Google Maps availability...');
        console.log('Google object:', typeof google);
        console.log('Map container:', mapContainer ? 'Found' : 'Not found');
        
        if (typeof google === 'undefined' || !google.maps) {
          console.log('🗺️ Google Maps not available, using canvas map');
          initSimpleMap();
        } else {
          console.log('🗺️ Google Maps available, initializing...');
          initGoogleMap();
        }
      }, 2000); // Increased delay to 2 seconds
      
      console.log('✅ Dashboard initialized successfully!');
    } catch (error) {
      console.error('❌ Dashboard initialization error:', error);
    }
  });
  
  // Add missing function for route showing
  function showVehicleRoute(busId) {
    showVehicleDetails(busId);
  }
  
  // Fallback initialization if DOMContentLoaded doesn't fire
  if (document.readyState === 'loading') {
    // Document still loading, wait for DOMContentLoaded
  } else {
    // Document already loaded, initialize immediately
    setTimeout(() => {
      if (!initialized) {
        console.log('🔄 Fallback initialization');
        document.dispatchEvent(new Event('DOMContentLoaded'));
      }
    }, 500);
  }
  
</script>
<!-- Google Maps API - Check if key is valid -->
<script>
  // Debug Google Maps loading
  window.gm_authFailure = function() {
    console.error('❌ Google Maps API key is invalid or expired');
    console.log('🗺️ Falling back to canvas map');
    if (!initialized) initSimpleMap();
  };
</script>
<script async defer 
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnOhQzKOIz6i3t_a0oK6K2d7bQ7BG2SFU&callback=initGoogleMap" 
  onerror="console.error('❌ Google Maps script failed to load'); if (!initialized) initSimpleMap();">
</script>
{% endblock %}

