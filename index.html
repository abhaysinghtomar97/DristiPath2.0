<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Tracking System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            background: #f0f8ff;
            overflow: hidden;
            position: relative;
        }
        #mapCanvas {
            border-radius: 8px;
            max-width: 100%;
            max-height: 100%;
        }
        .info-panel {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .bus-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: #ecf0f1;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.online {
            background: #2ecc71;
            color: white;
        }
        .status.offline {
            background: #e74c3c;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚌 Real-Time Bus Tracking System</h1>
        <p>Track buses in real-time on the map below</p>
    </div>

    <div class="container">
        <div class="info-panel">
            <h3>Controls</h3>
            <div style="display:flex; gap:12px; flex-wrap: wrap; align-items: center;">
                <button id="btn-refresh">Refresh Now</button>
                <button id="btn-my-location">Use My Location</button>
                <label>
                    Radius (km):
                    <input type="number" id="radius-km" min="1" max="50" value="5" style="width:60px;">
                </label>
                <button id="btn-nearest">Find Nearest Buses</button>
                <input type="text" id="search-query" placeholder="Search by bus no/route..." style="flex:1; min-width: 220px;">
                <button id="btn-search">Search</button>
            </div>
            <div id="nearest-results" style="margin-top:12px;"></div>
        </div>

        <div class="info-panel">
            <h3>Bus Status</h3>
            <div id="bus-list">
                <div class="loading">Loading bus information...</div>
            </div>
        </div>

        <div id="map"></div>
        
        <div class="info-panel">
            <h3>Admin Access</h3>
            <div id="admin-section">
                <div id="login-form" style="display: block;">
                    <p>Access the admin dashboard to manage buses and routes:</p>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="admin-username" placeholder="Username" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="password" id="admin-password" placeholder="Password" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button id="btn-admin-login" style="padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer;">Login to Admin</button>
                    </div>
                    <div id="login-message" style="margin-top: 10px;"></div>
                </div>
                <div id="admin-logged-in" style="display: none;">
                    <p>✅ Logged in as admin</p>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="btn-go-admin" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">Go to Admin Dashboard</button>
                        <button id="btn-admin-logout" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-panel">
            <h3>Instructions</h3>
            <ol>
                <li>Make sure your Django server is running: <code>python manage.py runserver</code></li>
                <li>Run the bus simulator: <code>python bus_simulator.py</code></li>
                <li>Watch buses move in real-time on the map</li>
                <li>Bus locations update every 5 seconds</li>
            </ol>
            <p><strong>Note:</strong> You can enable Google Maps later by adding your API key. For now, the simple map works without any key.</p>
        </div>
    </div>

    <script>
        let map;
        let markers = {};
        let infoWindows = {};

        function initMap() {
            // Initialize map centered on Delhi, India
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 11,
                center: { lat: 28.6139, lng: 77.2090 }, // Delhi coordinates
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // Start fetching bus locations
            fetchBusLocations();
            
            // Update locations every 5 seconds
            setInterval(fetchBusLocations, 5000);
        }

        async function fetchJSON(url, options={}) {
            console.log('Fetching:', url);
            const res = await fetch(url, options);
            console.log('Response status:', res.status, res.statusText);
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const data = await res.json();
            console.log('Response data:', data);
            return data;
        }

        function fetchBusLocations() {
            console.log('Starting to fetch bus locations...');
            fetchJSON('/api/get_locations/')
                .then(data => {
                    console.log('Bus locations fetched successfully:', data);
                    if (data.status === 'success') {
                        updateMap(data.locations);
                        updateBusList(data.locations);
                    } else {
                        console.error('Error fetching locations:', data.error);
                        updateBusList([]);
                    }
                })
                .catch(error => {
                    console.error('Network error fetching bus locations:', error);
                    updateBusList([]);
                });
        }

        async function useMyLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude, accuracy } = pos.coords;
                try {
                    await fetchJSON('/api/update_user_location/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ latitude, longitude, accuracy })
                    });
                    document.getElementById('nearest-results').innerHTML = `Your location set to: ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (±${Math.round(accuracy)}m)`;
                } catch (e) {
                    console.error('Failed to update user location', e);
                }
            }, (err) => {
                alert('Failed to get location: ' + err.message);
            });
        }

        async function findNearest() {
            const radius = parseFloat(document.getElementById('radius-km').value || '5');
            if (Number.isNaN(radius)) return;
            try {
                // If we had just set my location, we could reuse it; for simplicity, prompt or reuse last known via geolocation
                await new Promise((resolve) => navigator.geolocation.getCurrentPosition((pos) => resolve(pos), () => resolve(null)));
                const pos = await new Promise((resolve) => navigator.geolocation.getCurrentPosition((p)=>resolve(p), ()=>resolve(null)));
                let lat, lng;
                if (pos) { lat = pos.coords.latitude; lng = pos.coords.longitude; }
                else { lat = 28.6139; lng = 77.2090; }
                const data = await fetchJSON(`/api/find_nearest_buses/?lat=${lat}&lng=${lng}&radius=${radius}`);
                if (data.status === 'success') {
                    const html = data.nearest_buses.map(b => `
                        <div class="bus-info">
                            <div>
                                <strong>${b.bus_number} (${b.bus_id})</strong><br>
                                <small>Route: ${b.route_name || 'N/A'}</small>
                            </div>
                            <div>
                                <div class="status online">${b.distance_km} km</div>
                                <small>Lat: ${b.latitude.toFixed(4)}, Lng: ${b.longitude.toFixed(4)}</small>
                            </div>
                        </div>`).join('');
                    document.getElementById('nearest-results').innerHTML = html || '<div class="loading">No buses found within the selected radius.</div>';
                }
            } catch (e) {
                console.error('Failed to find nearest buses', e);
            }
        }

        async function searchBuses() {
            const q = encodeURIComponent(document.getElementById('search-query').value.trim());
            const data = await fetchJSON(`/api/search_buses/?q=${q}`);
            if (data.status === 'success') {
                updateBusList((data.buses || []).map(b => ({
                    bus_id: b.bus_id,
                    latitude: (b.current_location && b.current_location.latitude) || 28.6139,
                    longitude: (b.current_location && b.current_location.longitude) || 77.2090,
                    last_updated: (b.current_location && b.current_location.last_updated) || new Date().toISOString()
                })))
            }
        }

        function updateMap(locations) {
            if (typeof google !== 'undefined' && map) {
                // Google Maps version
                updateGoogleMap(locations);
            } else if (ctx) {
                // Simple canvas map version
                updateSimpleMap(locations);
            }
        }

        function updateGoogleMap(locations) {
            // Clear existing markers that are no longer active
            const activeBusIds = locations.map(location => location.bus_id);
            Object.keys(markers).forEach(busId => {
                if (!activeBusIds.includes(busId)) {
                    markers[busId].setMap(null);
                    if (infoWindows[busId]) {
                        infoWindows[busId].close();
                    }
                    delete markers[busId];
                    delete infoWindows[busId];
                }
            });

            // Update or create markers for each bus
            locations.forEach(location => {
                const position = {
                    lat: location.latitude,
                    lng: location.longitude
                };

                if (markers[location.bus_id]) {
                    // Update existing marker position
                    markers[location.bus_id].setPosition(position);
                } else {
                    // Create new marker
                    markers[location.bus_id] = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: location.bus_id,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
                                    <circle cx="15" cy="15" r="12" fill="#3498db" stroke="#2c3e50" stroke-width="2"/>
                                    <text x="15" y="19" text-anchor="middle" fill="white" font-family="Arial" font-size="10" font-weight="bold">🚌</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(30, 30),
                            anchor: new google.maps.Point(15, 15),
                        }
                    });
                }

                // Create or update info window
                const lastUpdated = new Date(location.last_updated).toLocaleTimeString();
                const infoContent = `
                    <div style="padding: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${location.bus_id}</h4>
                        <p style="margin: 5px 0;"><strong>Location:</strong> ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}</p>
                        <p style="margin: 5px 0;"><strong>Last Updated:</strong> ${lastUpdated}</p>
                    </div>
                `;

                if (infoWindows[location.bus_id]) {
                    infoWindows[location.bus_id].setContent(infoContent);
                } else {
                    infoWindows[location.bus_id] = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    markers[location.bus_id].addListener('click', () => {
                        // Close all other info windows
                        Object.values(infoWindows).forEach(iw => iw.close());
                        // Open this info window
                        infoWindows[location.bus_id].open(map, markers[location.bus_id]);
                    });
                }
            });
        }

        function updateSimpleMap(locations) {
            // Redraw background
            drawMapBackground();
            
            // Draw each bus
            locations.forEach((location, index) => {
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'];
                const color = colors[index % colors.length];
                drawBusMarker(location, color);
            });
        }

        function updateBusList(locations) {
            const busList = document.getElementById('bus-list');
            
            if (locations.length === 0) {
                busList.innerHTML = `
                    <div class="loading">
                        No buses currently active. Make sure the Django server and bus simulator are running.
                    </div>
                `;
                return;
            }

            const busListHTML = locations.map(location => {
                const lastUpdated = new Date(location.last_updated);
                const now = new Date();
                const timeDiff = (now - lastUpdated) / 1000; // seconds
                const isOnline = timeDiff < 30; // Consider online if updated within 30 seconds

                return `
                    <div class="bus-info">
                        <div>
                            <strong>${location.bus_number} (${location.route_name || location.route_id || 'Unknown Route'})</strong>
                            <br>
                            <small>Lat: ${location.latitude.toFixed(4)}, Lng: ${location.longitude.toFixed(4)}</small>
                        </div>
                        <div>
                            <div class="status ${isOnline ? 'online' : 'offline'}">
                                ${isOnline ? 'ONLINE' : 'OFFLINE'}
                            </div>
                            <small>Updated: ${lastUpdated.toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
            }).join('');

            busList.innerHTML = busListHTML;
        }

        // Simple coordinate map without Google Maps API
        let simpleMap;
        let ctx;
        const mapBounds = {
            minLat: 28.5000, maxLat: 28.7000,
            minLng: 77.1500, maxLng: 77.4000
        };

        function initSimpleMap() {
            simpleMap = document.getElementById('map');
            simpleMap.innerHTML = '<canvas id="mapCanvas"></canvas>';
            
            const canvas = document.getElementById('mapCanvas');
            
            // Set canvas size to match the container exactly
            const containerRect = simpleMap.getBoundingClientRect();
            canvas.width = containerRect.width;
            canvas.height = containerRect.height;
            
            // Set CSS size to match the container
            canvas.style.width = containerRect.width + 'px';
            canvas.style.height = containerRect.height + 'px';
            canvas.style.display = 'block';
            
            ctx = canvas.getContext('2d');
            
            console.log('Simple map initialized:', canvas.width, 'x', canvas.height);
            
            drawMapBackground();
            
            // Start fetching bus locations
            fetchBusLocations();
            
            // Update locations every 5 seconds
            setInterval(fetchBusLocations, 5000);
        }

        function drawMapBackground() {
            // Clear canvas
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            // Draw background
            ctx.fillStyle = '#f0f8ff';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // Vertical lines
            for (let i = 0; i <= 10; i++) {
                const x = (ctx.canvas.width / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, ctx.canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let i = 0; i <= 10; i++) {
                const y = (ctx.canvas.height / 10) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(ctx.canvas.width, y);
                ctx.stroke();
            }
            
            // Draw title
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Bus Movement Tracker - Delhi Area', ctx.canvas.width / 2, 30);
            
            // Draw coordinate labels
            ctx.font = '12px Arial';
            ctx.fillStyle = '#7f8c8d';
            ctx.textAlign = 'left';
            ctx.fillText(`Lat: ${mapBounds.maxLat} to ${mapBounds.minLat}`, 10, 60);
            ctx.fillText(`Lng: ${mapBounds.minLng} to ${mapBounds.maxLng}`, 10, 80);
        }

        function latLngToPixel(lat, lng) {
            const x = ((lng - mapBounds.minLng) / (mapBounds.maxLng - mapBounds.minLng)) * ctx.canvas.width;
            const y = ((mapBounds.maxLat - lat) / (mapBounds.maxLat - mapBounds.minLat)) * ctx.canvas.height;
            return { x, y };
        }

        function drawBusMarker(location, color = '#3498db') {
            const pos = latLngToPixel(location.latitude, location.longitude);
            
            // Draw bus circle
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 15, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw bus emoji/text
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('🚌', pos.x, pos.y + 4);
            
            // Draw bus number and route label
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 11px Arial';
            const busLabel = `${location.bus_number || location.bus_id}`;
            ctx.fillText(busLabel, pos.x, pos.y - 30);
            
            // Draw route name
            ctx.font = '9px Arial';
            ctx.fillStyle = '#34495e';
            const routeLabel = `(${location.route_name || location.route_id || 'Unknown'})`;
            ctx.fillText(routeLabel, pos.x, pos.y - 18);
            
            // Draw coordinates
            ctx.font = '9px Arial';
            ctx.fillStyle = '#7f8c8d';
            const coordText = `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`;
            ctx.fillText(coordText, pos.x, pos.y + 35);
        }

        // ============= Admin Authentication Functions =============
        
        async function adminLogin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value;
            const messageDiv = document.getElementById('login-message');
            
            if (!username || !password) {
                messageDiv.innerHTML = '<div style="color: #e74c3c;">Please enter both username and password</div>';
                return;
            }
            
            messageDiv.innerHTML = '<div style="color: #3498db;">Logging in...</div>';
            
            try {
                const data = await fetchJSON('/api/admin/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (data.status === 'success') {
                    messageDiv.innerHTML = '<div style="color: #27ae60;">✅ Login successful!</div>';
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('admin-logged-in').style.display = 'block';
                    
                    // Clear password field for security
                    document.getElementById('admin-password').value = '';
                } else {
                    messageDiv.innerHTML = `<div style="color: #e74c3c;">❌ ${data.error || 'Login failed'}</div>`;
                }
            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = '<div style="color: #e74c3c;">❌ Login failed. Please check your credentials.</div>';
            }
        }
        
        async function adminLogout() {
            try {
                await fetchJSON('/api/admin/logout/');
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('admin-logged-in').style.display = 'none';
                document.getElementById('login-message').innerHTML = '<div style="color: #3498db;">Logged out successfully</div>';
                
                // Clear form fields
                document.getElementById('admin-username').value = '';
                document.getElementById('admin-password').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        function goToAdminDashboard() {
            window.location.href = '/admin_panel/';
        }

        // Initialize map when page loads
        window.onload = function() {
            console.log('Page loaded, checking Google Maps...');
            // Hook up controls
            document.getElementById('btn-refresh').onclick = fetchBusLocations;
            document.getElementById('btn-my-location').onclick = useMyLocation;
            document.getElementById('btn-nearest').onclick = findNearest;
            document.getElementById('btn-search').onclick = searchBuses;
            
            // Hook up admin controls
            document.getElementById('btn-admin-login').onclick = adminLogin;
            document.getElementById('btn-admin-logout').onclick = adminLogout;
            document.getElementById('btn-go-admin').onclick = goToAdminDashboard;
            
            // Allow Enter key to submit login
            document.getElementById('admin-password').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    adminLogin();
                }
            };
            
            // Check if Google Maps is loaded
            if (typeof google === 'undefined') {
                console.log('Google Maps not found, using simple coordinate map');
                // Use simple coordinate map
                initSimpleMap();
            } else {
                console.log('Google Maps found, using Google Maps');
                initMap();
            }
        };
    </script>

    <!-- Google Maps Script - DISABLED to use simple canvas map instead
    TO ENABLE GOOGLE MAPS:
    1. Get a Google Maps API key from: https://console.cloud.google.com/
    2. Replace YOUR_API_KEY_HERE below with your actual API key
    3. Remove the comment tags around this script
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&callback=initMap">
    </script>
    -->
</body>
</html>
